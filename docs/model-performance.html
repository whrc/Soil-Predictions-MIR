<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7 Model Performance | Soil Predictions using MIR-Spectroscopy</title>
  <meta name="description" content="7 Model Performance | Soil Predictions using MIR-Spectroscopy" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="7 Model Performance | Soil Predictions using MIR-Spectroscopy" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 Model Performance | Soil Predictions using MIR-Spectroscopy" />
  
  
  

<meta name="author" content="Charlotte Rivard" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="mbl-models.html"/>
<link rel="next" href="mbl-ensemble-approach.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Soil Predictions using MIR-Spectroscopy</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="background.html"><a href="background.html"><i class="fa fa-check"></i><b>2</b> Background</a></li>
<li class="chapter" data-level="3" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>3</b> Getting Started</a><ul>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#file-walkthrough"><i class="fa fa-check"></i>File Walkthrough</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#required-packages"><i class="fa fa-check"></i>Required Packages</a><ul>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#simplerspec"><i class="fa fa-check"></i>simplerspec</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#stringr"><i class="fa fa-check"></i>stringr</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#foreach"><i class="fa fa-check"></i>foreach</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#prospectr"><i class="fa fa-check"></i>prospectr</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#clhs"><i class="fa fa-check"></i>clhs</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#matrixstats"><i class="fa fa-check"></i>matrixStats</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#plot3d"><i class="fa fa-check"></i>plot3D</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#pls"><i class="fa fa-check"></i>pls</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#resemble"><i class="fa fa-check"></i>resemble</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#demo-script"><i class="fa fa-check"></i>Demo Script</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-preprocessing.html"><a href="data-preprocessing.html"><i class="fa fa-check"></i><b>4</b> Data Preprocessing</a><ul>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#get-spectral-library"><i class="fa fa-check"></i>Get Spectral Library</a><ul>
<li><a href="data-preprocessing.html#getspeclib"><code>getSpecLib()</code></a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#extract-spectra"><i class="fa fa-check"></i>Extract Spectra</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#process-spectra"><i class="fa fa-check"></i>Process Spectra</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#merge-with-lab-data"><i class="fa fa-check"></i>Merge with Lab Data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#refine-spectral-library"><i class="fa fa-check"></i>Refine Spectral Library</a><ul>
<li><a href="data-preprocessing.html#refinespeclib"><code>refineSpecLib()</code></a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#large-sets"><i class="fa fa-check"></i>Large Sets</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#faulty-lab-data"><i class="fa fa-check"></i>Faulty Lab Data</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#outliers"><i class="fa fa-check"></i>Outliers</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#calval-groups"><i class="fa fa-check"></i>Cal/Val Groups</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="plsr-models.html"><a href="plsr-models.html"><i class="fa fa-check"></i><b>5</b> PLSR Models</a><ul>
<li class="chapter" data-level="" data-path="plsr-models.html"><a href="plsr-models.html#model-theory"><i class="fa fa-check"></i>Model Theory</a></li>
<li class="chapter" data-level="" data-path="plsr-models.html"><a href="plsr-models.html#making-plsr-models"><i class="fa fa-check"></i>Making PLSR Models</a><ul>
<li><a href="plsr-models.html#makeplsmodel"><code>makePLSModel()</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="plsr-models.html"><a href="plsr-models.html#getting-pls-predictions"><i class="fa fa-check"></i>Getting PLS Predictions</a><ul>
<li><a href="plsr-models.html#getpredpls"><code>getPredPLS()</code></a></li>
<li><a href="plsr-models.html#ncomponesigma"><code>ncompOneSigma()</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="mbl-models.html"><a href="mbl-models.html"><i class="fa fa-check"></i><b>6</b> MBL Models</a><ul>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#model-theory-1"><i class="fa fa-check"></i>Model Theory</a><ul>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#overview"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#animation"><i class="fa fa-check"></i>Animation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#running-mbl"><i class="fa fa-check"></i>Running MBL</a><ul>
<li><a href="mbl-models.html#runmbl"><code>runMBL()</code></a></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#modeling-parameters"><i class="fa fa-check"></i>Modeling Parameters</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#getting-mbl-predictions"><i class="fa fa-check"></i>Getting MBL Predictions</a><ul>
<li><a href="mbl-models.html#bestmodmbl"><code>bestModMBL()</code></a></li>
<li><a href="mbl-models.html#getpredmbl"><code>getPredMBL()</code></a></li>
<li><a href="mbl-models.html#getlabmbl"><code>getLabMBL()</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="model-performance.html"><a href="model-performance.html"><i class="fa fa-check"></i><b>7</b> Model Performance</a><ul>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#get-results"><i class="fa fa-check"></i>Get Results</a><ul>
<li><a href="model-performance.html#getmodresults"><code>getModResults()</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#predictions"><i class="fa fa-check"></i>Predictions</a><ul>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#getsavepredtable"><i class="fa fa-check"></i>getSavePredTable()</a></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#savepredictions"><i class="fa fa-check"></i>savePredictions()</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#statistics"><i class="fa fa-check"></i>Statistics</a><ul>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#getmodstats"><i class="fa fa-check"></i>getModStats()</a></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#savemodstats"><i class="fa fa-check"></i>saveModStats()</a></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#calcudev"><i class="fa fa-check"></i>calcUDev()</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#plots"><i class="fa fa-check"></i>Plots</a><ul>
<li><a href="model-performance.html#plotpred"><code>plotPred()</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="mbl-ensemble-approach.html"><a href="mbl-ensemble-approach.html"><i class="fa fa-check"></i><b>8</b> MBL Ensemble Approach</a><ul>
<li class="chapter" data-level="" data-path="mbl-ensemble-approach.html"><a href="mbl-ensemble-approach.html#model-iterations"><i class="fa fa-check"></i>Model Iterations</a></li>
<li class="chapter" data-level="" data-path="mbl-ensemble-approach.html"><a href="mbl-ensemble-approach.html#getting-started-1"><i class="fa fa-check"></i>Getting started</a><ul>
<li class="chapter" data-level="" data-path="mbl-ensemble-approach.html"><a href="mbl-ensemble-approach.html#file-walkthrough-1"><i class="fa fa-check"></i>File Walkthrough</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Soil Predictions using MIR-Spectroscopy</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="model-performance" class="section level1">
<h1><span class="header-section-number">7</span> Model Performance</h1>
<p>The following section describes the function <code>getModResults()</code> which coordinates the steps after your pls or mbl model is created:</p>
<ol style="list-style-type: decimal">
<li><p>Getting Predictions</p></li>
<li><p>Calculating Uncertainty</p></li>
<li><p>Generating Summary Statistics</p></li>
<li><p>Displaying Plots</p></li>
</ol>
<p>This allows us to assess the performance of the model. How close are the predictions to the observed lab data? If you do not have lab data to compare your predictions to, you should simply use the functions <code>getPredPLS()</code> and <code>getPredMBL()</code></p>
<div id="get-results" class="section level2 unnumbered">
<h2>Get Results</h2>
<p>The following function returns the results for either pls or mbl models, calling upon <code>getPredPLS()</code> and <code>getPredMBL()</code> functions, then generates summary statistics and a plot of the predictions against the observations.</p>
<div id="getmodresults" class="section level3 unnumbered">
<h3><code>getModResults()</code></h3>
<ul>
<li><code>getModResults()</code>
<ul>
<li><code>PROP</code>: <em>string</em>- The column name of the soil property of interest. Ex: “OC”</li>
<li><code>MODTYPE</code>: <em>string</em>- “MBL” or “PLS”</li>
<li><code>MODNAME</code>: <em>string</em>- The name of the model variable, if it is already loaded into the R environment. Use MODNAME or MODPATH</li>
<li><code>MODPATH</code>: <em>string</em>- The path the the RData file containing your model, if the model is not already loaded. Use MODNAME or MODPATH</li>
<li><code>PREDNAME</code>: <em>string</em>- The name of the prediction set variable, if it is already loaded into the R environment, that will be used to create the model. Use PREDNAME or PREDPATH</li>
<li><code>PREDPATH</code>: <em>string</em>- The path the the RData file containing your prediction set, if the prediction set is not already loaded. PREDNAME or PREDPATH</li>
<li><code>SAVEPRED</code>: <em>boolean</em>- Whether or not to save the predictions. If TRUE, predictions will be saved to the folder ‘Predictions’ using the function <code>savePredictions()</code>. Default is set to TRUE</li>
<li><code>MODPERF</code>: <em>boolean</em>- Whether or not to generate and show the prediction performance statistics. If TRUE, these statistics will be generated by the <code>getModStats()</code> function, and saved in the folder ‘Predictions’ in the performance log.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" data-line-number="1">getModResults &lt;-<span class="st"> </span><span class="cf">function</span>(PROP, MODTYPE, <span class="dt">MODNAME=</span><span class="ot">NA</span>, <span class="dt">MODPATH=</span><span class="ot">NA</span>, <span class="dt">PREDNAME=</span><span class="ot">NA</span>, <span class="dt">PREDPATH=</span><span class="ot">NA</span>, <span class="dt">SAVEPRED=</span><span class="ot">TRUE</span>, <span class="dt">MODPERF=</span><span class="ot">TRUE</span>){</a>
<a class="sourceLine" id="cb53-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb53-3" data-line-number="3">  <span class="co"># Load Model</span></a>
<a class="sourceLine" id="cb53-4" data-line-number="4">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(MODPATH)){</a>
<a class="sourceLine" id="cb53-5" data-line-number="5">    MODNAME &lt;-<span class="st"> </span><span class="kw">load</span>(MODPATH)</a>
<a class="sourceLine" id="cb53-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb53-7" data-line-number="7">  model &lt;-<span class="st"> </span><span class="kw">get</span>(MODNAME)</a>
<a class="sourceLine" id="cb53-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb53-9" data-line-number="9">  <span class="co"># Load Prediction Set</span></a>
<a class="sourceLine" id="cb53-10" data-line-number="10">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(PREDPATH)){</a>
<a class="sourceLine" id="cb53-11" data-line-number="11">    PREDNAME &lt;-<span class="st"> </span><span class="kw">load</span>(PREDPATH)</a>
<a class="sourceLine" id="cb53-12" data-line-number="12">  }</a>
<a class="sourceLine" id="cb53-13" data-line-number="13">  predSet &lt;-<span class="st"> </span><span class="kw">get</span>(PREDNAME)</a>
<a class="sourceLine" id="cb53-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb53-15" data-line-number="15">  <span class="co"># Extract Predictions</span></a>
<a class="sourceLine" id="cb53-16" data-line-number="16">  <span class="cf">if</span>(MODTYPE<span class="op">==</span><span class="st">&quot;MBL&quot;</span>){</a>
<a class="sourceLine" id="cb53-17" data-line-number="17">    ncomp_onesigma &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb53-18" data-line-number="18">    pred_type &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb53-19" data-line-number="19">    predictions &lt;-<span class="st"> </span><span class="kw">getPredMBL</span>(model)</a>
<a class="sourceLine" id="cb53-20" data-line-number="20">  }</a>
<a class="sourceLine" id="cb53-21" data-line-number="21">  <span class="cf">if</span>(MODTYPE<span class="op">==</span><span class="st">&quot;PLS&quot;</span>){</a>
<a class="sourceLine" id="cb53-22" data-line-number="22">    <span class="co"># Find Optimal Number of Components</span></a>
<a class="sourceLine" id="cb53-23" data-line-number="23">    ncomp_onesigma &lt;-<span class="st"> </span><span class="kw">selectNcomp</span>(model, <span class="dt">method =</span> <span class="st">&quot;onesigma&quot;</span>, <span class="dt">plot=</span><span class="ot">TRUE</span>, <span class="dt">main=</span>PROP)</a>
<a class="sourceLine" id="cb53-24" data-line-number="24">    <span class="co"># Get Predictions</span></a>
<a class="sourceLine" id="cb53-25" data-line-number="25">    pred_type &lt;-<span class="st"> &quot;predict&quot;</span></a>
<a class="sourceLine" id="cb53-26" data-line-number="26">    predictions &lt;-<span class="st"> </span><span class="kw">getPredPLS</span>(model, ncomp_onesigma, pred_type , predSet)</a>
<a class="sourceLine" id="cb53-27" data-line-number="27">  }</a>
<a class="sourceLine" id="cb53-28" data-line-number="28">  </a>
<a class="sourceLine" id="cb53-29" data-line-number="29">  <span class="co"># Get Pred Versus Observations</span></a>
<a class="sourceLine" id="cb53-30" data-line-number="30">  lab_data &lt;-<span class="st"> </span>predSet[,PROP] <span class="co"># Lab Data</span></a>
<a class="sourceLine" id="cb53-31" data-line-number="31">  predobs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(predSet[,<span class="st">&quot;sample_id&quot;</span>], predictions, lab_data)</a>
<a class="sourceLine" id="cb53-32" data-line-number="32">  <span class="kw">names</span>(predobs) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;sample_id&quot;</span>,<span class="st">&quot;pred&quot;</span>,<span class="st">&quot;obs&quot;</span>)</a>
<a class="sourceLine" id="cb53-33" data-line-number="33">  </a>
<a class="sourceLine" id="cb53-34" data-line-number="34">  <span class="co"># {Optional} Model Performance</span></a>
<a class="sourceLine" id="cb53-35" data-line-number="35">  <span class="cf">if</span>(MODPERF<span class="op">==</span><span class="ot">TRUE</span>){</a>
<a class="sourceLine" id="cb53-36" data-line-number="36">    modstats &lt;-<span class="st"> </span><span class="kw">getModStats</span>(<span class="dt">PREDOBS=</span> predobs, <span class="dt">PROP=</span>PROP, <span class="dt">NCOMP=</span>ncomp_onesigma, <span class="dt">MODNAME=</span>MODNAME, </a>
<a class="sourceLine" id="cb53-37" data-line-number="37">                            <span class="dt">PREDTYPE=</span> pred_type, <span class="dt">PREDNAME=</span>PREDNAME, <span class="dt">SAVE=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb53-38" data-line-number="38">  }</a>
<a class="sourceLine" id="cb53-39" data-line-number="39">  <span class="co"># {Optional} Save Predictions</span></a>
<a class="sourceLine" id="cb53-40" data-line-number="40">  <span class="cf">if</span>(SAVEPRED<span class="op">==</span><span class="ot">TRUE</span>){</a>
<a class="sourceLine" id="cb53-41" data-line-number="41">    <span class="kw">savePredictions</span>(predobs, PROP, MODTYPE, predSet, <span class="kw">paste0</span>(PREDNAME,<span class="st">&quot;_predictions.csv&quot;</span>))</a>
<a class="sourceLine" id="cb53-42" data-line-number="42">  }</a>
<a class="sourceLine" id="cb53-43" data-line-number="43">  <span class="kw">names</span>(predobs) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;sample_id&quot;</span>, <span class="kw">paste0</span>(PROP,<span class="st">&quot;.&quot;</span>,MODTYPE), PROP)</a>
<a class="sourceLine" id="cb53-44" data-line-number="44">  <span class="kw">return</span>(predobs)</a>
<a class="sourceLine" id="cb53-45" data-line-number="45">}</a></code></pre></div>
</div>
</div>
<div id="predictions" class="section level2 unnumbered">
<h2>Predictions</h2>
<p>Predictions are extracting using either <code>getPredPLS()</code> or <code>getPredMBL()</code>. These are called within <code>getModResults()</code> before being saved. The following functions save predictions to a file unique to each prediction set. If this file already exists, it simply adds another column of predictions. If it does not, it will create the file to save predictions in from the original prediction set.</p>
<div id="getsavepredtable" class="section level3 unnumbered">
<h3>getSavePredTable()</h3>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" data-line-number="1">getSavePredTable &lt;-<span class="st"> </span><span class="cf">function</span>(PREDSET, SAVENAME){</a>
<a class="sourceLine" id="cb54-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb54-3" data-line-number="3">  <span class="cf">if</span>(<span class="kw">file.exists</span>(<span class="st">&quot;./Predictions&quot;</span>)<span class="op">==</span><span class="ot">FALSE</span>){<span class="kw">dir.create</span>(<span class="st">&quot;./Predictions&quot;</span>)}</a>
<a class="sourceLine" id="cb54-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb54-5" data-line-number="5">  predSavePath &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;./Predictions/&quot;</span>, SAVENAME)</a>
<a class="sourceLine" id="cb54-6" data-line-number="6">  <span class="cf">if</span>(<span class="kw">file.exists</span>(predSavePath) ){</a>
<a class="sourceLine" id="cb54-7" data-line-number="7">    all_predictions &lt;-<span class="st"> </span><span class="kw">read.csv</span>(predSavePath)</a>
<a class="sourceLine" id="cb54-8" data-line-number="8">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb54-9" data-line-number="9">    all_predictions &lt;-<span class="st"> </span>PREDSET[,<span class="op">-</span><span class="kw">ncol</span>(PREDSET)] <span class="co"># remove spectra, last column</span></a>
<a class="sourceLine" id="cb54-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb54-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb54-12" data-line-number="12">  <span class="kw">return</span>(all_predictions)</a>
<a class="sourceLine" id="cb54-13" data-line-number="13">}</a></code></pre></div>
</div>
<div id="savepredictions" class="section level3 unnumbered">
<h3>savePredictions()</h3>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" data-line-number="1">savePredictions &lt;-<span class="st"> </span><span class="cf">function</span>(PREDOBS, PROP, MODTYPE, PREDSET, SAVENAME){</a>
<a class="sourceLine" id="cb55-2" data-line-number="2">  all_predictions &lt;-<span class="st"> </span><span class="kw">getSavePredTable</span>(PREDSET, SAVENAME) <span class="co"># Make/Load file to save predictions</span></a>
<a class="sourceLine" id="cb55-3" data-line-number="3">  savename &lt;-<span class="st"> </span><span class="kw">paste</span>(PROP,MODTYPE,<span class="dt">sep=</span><span class="st">&quot;.&quot;</span>) <span class="co"># Ex: OC.PLSR column name</span></a>
<a class="sourceLine" id="cb55-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb55-5" data-line-number="5">  <span class="cf">if</span>(<span class="op">!</span>(savename <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(all_predictions))){</a>
<a class="sourceLine" id="cb55-6" data-line-number="6">    </a>
<a class="sourceLine" id="cb55-7" data-line-number="7">    all_predictions &lt;-<span class="st"> </span><span class="kw">merge</span>(all_predictions, PREDOBS[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] , <span class="dt">all.X=</span><span class="ot">TRUE</span>) <span class="co"># Merge with all_predictions</span></a>
<a class="sourceLine" id="cb55-8" data-line-number="8">    ncolm &lt;-<span class="st"> </span><span class="kw">ncol</span>(all_predictions)</a>
<a class="sourceLine" id="cb55-9" data-line-number="9">    <span class="kw">names</span>(all_predictions)[ncolm] &lt;-<span class="st"> </span>savename</a>
<a class="sourceLine" id="cb55-10" data-line-number="10">    savefile &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Predictions/&quot;</span>, SAVENAME) <span class="co"># Set file savename</span></a>
<a class="sourceLine" id="cb55-11" data-line-number="11">    <span class="kw">write.csv</span>(all_predictions, <span class="dt">file=</span>savefile, <span class="dt">row.names=</span><span class="ot">FALSE</span>) <span class="co"># Save</span></a>
<a class="sourceLine" id="cb55-12" data-line-number="12">    </a>
<a class="sourceLine" id="cb55-13" data-line-number="13">    <span class="kw">cat</span>(<span class="kw">paste</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Predictions saved to&quot;</span>, savefile)) <span class="co"># Print save location</span></a>
<a class="sourceLine" id="cb55-14" data-line-number="14">    </a>
<a class="sourceLine" id="cb55-15" data-line-number="15">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb55-16" data-line-number="16">    <span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Prediction column already exists&quot;</span>)</a>
<a class="sourceLine" id="cb55-17" data-line-number="17">  }</a>
<a class="sourceLine" id="cb55-18" data-line-number="18">  </a>
<a class="sourceLine" id="cb55-19" data-line-number="19">  <span class="kw">View</span>(all_predictions)</a>
<a class="sourceLine" id="cb55-20" data-line-number="20">}</a></code></pre></div>
</div>
</div>
<div id="statistics" class="section level2 unnumbered">
<h2>Statistics</h2>
<p>After making predictions using either of the modeling methods, various summary statistics can help test the accuracy of those predictions. The u-deviation, as a measure of uncertainty, can help assess how much each prediction can be trusted.</p>
<div id="getmodstats" class="section level3 unnumbered">
<h3>getModStats()</h3>
<p>The getModStats function returns the following statistics in a dataframe:</p>
<ul>
<li>R2<br />
</li>
<li>R2 adjusted<br />
</li>
<li>Slope<br />
</li>
<li>Y-Intercept<br />
</li>
<li>RMSE<br />
</li>
<li>Bias<br />
</li>
<li>Standard deviation (of predictions)<br />
</li>
<li>Residual prediction deviation</li>
</ul>
<p>The minimum input is the PREDOBS table containing a column ‘pred’, containing the predictions and a column ‘obs’, its corresponding lab data. The remaining parameters are characteristics about the models and prediction runs that are important to include if you are saving the statistics.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" data-line-number="1">getModStats &lt;-<span class="st"> </span><span class="cf">function</span>(PREDOBS, <span class="dt">PROP=</span><span class="ot">NA</span>, <span class="dt">NCOMP=</span><span class="ot">NA</span>, <span class="dt">MODNAME=</span><span class="ot">NA</span>, <span class="dt">PREDTYPE=</span><span class="ot">NA</span>, <span class="dt">PREDNAME=</span><span class="ot">NA</span>, <span class="dt">SAVE=</span><span class="ot">FALSE</span>){</a>
<a class="sourceLine" id="cb56-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb56-3" data-line-number="3">  <span class="kw">print</span>(<span class="kw">paste</span>(PROP, <span class="st">&quot;Summary&quot;</span>))</a>
<a class="sourceLine" id="cb56-4" data-line-number="4">  TIME &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="kw">Sys.time</span>()[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb56-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb56-6" data-line-number="6">  <span class="co"># Regress predicted versus observed</span></a>
<a class="sourceLine" id="cb56-7" data-line-number="7">  PREDOBS &lt;-<span class="st"> </span><span class="kw">na.omit</span>(PREDOBS)</a>
<a class="sourceLine" id="cb56-8" data-line-number="8">  reg_mod &lt;-<span class="st"> </span><span class="kw">lm</span>(PREDOBS<span class="op">$</span>pred <span class="op">~</span><span class="st"> </span>PREDOBS<span class="op">$</span>obs)</a>
<a class="sourceLine" id="cb56-9" data-line-number="9">  sum_perf &lt;-<span class="st"> </span><span class="kw">summary</span>(reg_mod)</a>
<a class="sourceLine" id="cb56-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb56-11" data-line-number="11">  <span class="co"># Get statistics</span></a>
<a class="sourceLine" id="cb56-12" data-line-number="12">  R2 &lt;-<span class="st"> </span><span class="kw">round</span>(sum_perf<span class="op">$</span>r.squared,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb56-13" data-line-number="13">  R2_adj &lt;-<span class="st"> </span><span class="kw">round</span>(sum_perf<span class="op">$</span>adj.r.squared,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb56-14" data-line-number="14">  b0 &lt;-<span class="st"> </span><span class="kw">round</span>(sum_perf<span class="op">$</span>coefficients[<span class="dv">1</span>], <span class="dv">2</span>) <span class="co"># Y-Intercept</span></a>
<a class="sourceLine" id="cb56-15" data-line-number="15">  b1 &lt;-<span class="st"> </span><span class="kw">round</span>(sum_perf<span class="op">$</span>coefficients[<span class="dv">2</span>],<span class="dv">2</span>) <span class="co"># Slope</span></a>
<a class="sourceLine" id="cb56-16" data-line-number="16">  RMSE &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">sqrt</span>(<span class="kw">mean</span>((PREDOBS<span class="op">$</span>pred <span class="op">-</span><span class="st"> </span>PREDOBS<span class="op">$</span>obs)<span class="op">^</span><span class="dv">2</span>)),<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb56-17" data-line-number="17">  bias &lt;-<span class="st"> </span><span class="kw">round</span>((<span class="kw">sum</span>(PREDOBS<span class="op">$</span>pred, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">-</span><span class="st"> </span><span class="kw">sum</span>(PREDOBS<span class="op">$</span>obs, <span class="dt">na.rm=</span><span class="ot">TRUE</span>))<span class="op">/</span><span class="kw">length</span>(PREDOBS<span class="op">$</span>obs),<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb56-18" data-line-number="18">  std &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">sd</span>(PREDOBS<span class="op">$</span>pred, <span class="dt">na.rm=</span><span class="ot">TRUE</span>),<span class="dv">2</span>) <span class="co"># Standard Deviation</span></a>
<a class="sourceLine" id="cb56-19" data-line-number="19">  rpd &lt;-<span class="st"> </span><span class="kw">round</span>(std <span class="op">/</span><span class="st"> </span>RMSE,<span class="dv">2</span>) <span class="co"># Residual Prediction Deviation</span></a>
<a class="sourceLine" id="cb56-20" data-line-number="20">  </a>
<a class="sourceLine" id="cb56-21" data-line-number="21">  <span class="co"># Assemble Row</span></a>
<a class="sourceLine" id="cb56-22" data-line-number="22">  modStats &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Timestamp=</span>TIME, <span class="dt">Property=</span>PROP, <span class="dt">Mod_Name=</span>MODNAME, <span class="dt">Pred_Type=</span>PREDTYPE,</a>
<a class="sourceLine" id="cb56-23" data-line-number="23">                         <span class="dt">Pred_Data=</span>PREDNAME, <span class="dt">ncomp=</span>NCOMP, <span class="dt">R2=</span>R2, <span class="dt">R2_Adj=</span>R2_adj, <span class="dt">Y_Int=</span>b0, <span class="dt">Slope=</span>b1,</a>
<a class="sourceLine" id="cb56-24" data-line-number="24">                         <span class="dt">RMSE=</span>RMSE, <span class="dt">bias=</span>bias,<span class="dt">STD=</span>std, <span class="dt">RPD=</span>rpd)</a>
<a class="sourceLine" id="cb56-25" data-line-number="25">  </a>
<a class="sourceLine" id="cb56-26" data-line-number="26">  <span class="co"># Write Row </span></a>
<a class="sourceLine" id="cb56-27" data-line-number="27">  <span class="cf">if</span>(SAVE<span class="op">==</span><span class="ot">TRUE</span>){<span class="kw">saveModStats</span>(modStats)}</a>
<a class="sourceLine" id="cb56-28" data-line-number="28">  </a>
<a class="sourceLine" id="cb56-29" data-line-number="29">  <span class="co"># Plot Pred Obs</span></a>
<a class="sourceLine" id="cb56-30" data-line-number="30">  <span class="kw">plot.plsr</span>(PREDOBS<span class="op">$</span>obs, PREDOBS<span class="op">$</span>pred, modStats, <span class="kw">paste</span>(MODNAME,PREDNAME,<span class="st">&quot;Predictions&quot;</span>), <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb56-31" data-line-number="31">  </a>
<a class="sourceLine" id="cb56-32" data-line-number="32">  <span class="co"># Print Statistics</span></a>
<a class="sourceLine" id="cb56-33" data-line-number="33">  <span class="kw">print</span>(<span class="kw">t</span>(modStats))</a>
<a class="sourceLine" id="cb56-34" data-line-number="34">  </a>
<a class="sourceLine" id="cb56-35" data-line-number="35">  <span class="kw">return</span>(modStats)</a>
<a class="sourceLine" id="cb56-36" data-line-number="36">} <span class="co"># End of getModStats</span></a></code></pre></div>
<p><img src="images/stats.png" /></p>
</div>
<div id="savemodstats" class="section level3 unnumbered">
<h3>saveModStats()</h3>
<p>The following function will save the prediction statistics and information as a row in the performance log: <code>Predictions/prediction_performance.csv</code></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1">saveModStats &lt;-<span class="st"> </span><span class="cf">function</span>(MODSTATS){</a>
<a class="sourceLine" id="cb57-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb57-3" data-line-number="3">  <span class="cf">if</span>(<span class="kw">file.exists</span>(<span class="st">&quot;./Predictions&quot;</span>)<span class="op">==</span><span class="ot">FALSE</span>){<span class="kw">dir.create</span>(<span class="st">&quot;./Predictions&quot;</span>)}</a>
<a class="sourceLine" id="cb57-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb57-5" data-line-number="5">  modStats_file &lt;-<span class="st"> &quot;Predictions/prediction_performance.csv&quot;</span></a>
<a class="sourceLine" id="cb57-6" data-line-number="6">  <span class="cf">if</span>(<span class="kw">file.exists</span>(modStats_file)<span class="op">==</span><span class="ot">FALSE</span>){</a>
<a class="sourceLine" id="cb57-7" data-line-number="7">    <span class="kw">write.csv</span>(MODSTATS, <span class="dt">file =</span> modStats_file, <span class="dt">row.names=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb57-8" data-line-number="8">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb57-9" data-line-number="9">    save_table &lt;-<span class="st"> </span><span class="kw">read.csv</span>(modStats_file)</a>
<a class="sourceLine" id="cb57-10" data-line-number="10">    save_table &lt;-<span class="st"> </span><span class="kw">rbind</span>(save_table,MODSTATS)</a>
<a class="sourceLine" id="cb57-11" data-line-number="11">    <span class="kw">write.csv</span>(save_table, modStats_file, <span class="dt">row.names=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb57-12" data-line-number="12">  }</a>
<a class="sourceLine" id="cb57-13" data-line-number="13">  <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Statistics saved to&quot;</span>, modStats_file))</a>
<a class="sourceLine" id="cb57-14" data-line-number="14">}</a></code></pre></div>
</div>
<div id="calcudev" class="section level3 unnumbered">
<h3>calcUDev()</h3>
<p>We can calculate <strong>uncertainty</strong> for our predictions with the <strong>u-deviation</strong> which takes into account both differences in the spectra of the prediction and reference sets, as well as the prediction performance measured against observed values. The equation for the u-deviation is shown below and explained within
<a href="https://www.camo.com/helpdocs/The_Unscrambler_Method_References.pdf"><strong>The Unscrambler Method References</strong></a></p>
<p><img src="images/udev.png" /></p>
<ul>
<li><p><strong>ResXValSamp</strong>: The residual variance for the prediction set spectra. See <code>getResXValSamp()</code>. When this is higher, the udeviation is higher.</p></li>
<li><p><strong>ResXValTot</strong>: The average residual variance for the reference set spectra. See <code>getResXValTot()</code>. When this is higher, the udeviation is lower.</p></li>
<li><p><strong>ResYValVar</strong>: The variance in predictions from their observed values using a cross validation method. When this is higher, the udeviation is higher.</p></li>
<li><p><strong>Hi</strong>: The leverage is the distance of how far samples in the prediction set are from those in the reference set. See <code>getLeverage()</code>. When this is higher, the udeviation is higher.</p></li>
<li><p><strong>Ical</strong>: The number of samples in the calibration/reference set. When this is higher, the u-deviation is lower.</p></li>
</ul>
<p>The following functions orchestrate these calculations:</p>
<div id="calcudev-1" class="section level4 unnumbered">
<h4><code>calcUDev()</code></h4>
<p>This function prepares the input terms of the u-deviation equation, calling the following functions in this section, and then makes the calculation. u-deviation estimates for each prediction and number of components in the model, will be returned as a matrix.</p>
<p>To calculate the u-deviation run <code>source(&quot;Functions/udev_functions.R&quot;)</code> to load the appropriate functions and
<code>udeviation &lt;- calcUDev(plsr.OC, refSet, predSet, &quot;OC&quot;)</code> with the model, reference set, prediction set and property you are working with.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1">calcUDev &lt;-<span class="st"> </span><span class="cf">function</span>(MODEL, REFSET, PREDSET, PROP){</a>
<a class="sourceLine" id="cb58-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb58-3" data-line-number="3">  x.cal.scores &lt;-<span class="st"> </span>MODEL<span class="op">$</span>scores  <span class="co"># Scores of reference + prediction sets</span></a>
<a class="sourceLine" id="cb58-4" data-line-number="4">  x.val.scores &lt;-<span class="st"> </span><span class="kw">predict</span>(MODEL, <span class="dt">newdata =</span> PREDSET<span class="op">$</span>spc, <span class="dt">type =</span> <span class="st">&quot;scores&quot;</span>) </a>
<a class="sourceLine" id="cb58-5" data-line-number="5">  y.val.pred &lt;-<span class="st"> </span><span class="kw">predict</span>(MODEL, <span class="dt">newdata =</span> PREDSET<span class="op">$</span>spc)</a>
<a class="sourceLine" id="cb58-6" data-line-number="6">  y.val.pred &lt;-<span class="st"> </span>y.val.pred[,<span class="dv">1</span>,] <span class="co"># Predictions</span></a>
<a class="sourceLine" id="cb58-7" data-line-number="7">  loadings &lt;-<span class="st"> </span>MODEL<span class="op">$</span>loadings    <span class="co"># Model loadings</span></a>
<a class="sourceLine" id="cb58-8" data-line-number="8">  x.val &lt;-<span class="st"> </span>PREDSET<span class="op">$</span>spc          <span class="co"># Spectra of prediction set</span></a>
<a class="sourceLine" id="cb58-9" data-line-number="9">  obs &lt;-<span class="st"> </span>PREDSET[,PROP]         <span class="co"># Lab data for prediction set</span></a>
<a class="sourceLine" id="cb58-10" data-line-number="10">  ncalobj &lt;-<span class="st"> </span><span class="kw">nrow</span>(REFSET)       <span class="co"># Number of callibration samples</span></a>
<a class="sourceLine" id="cb58-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb58-12" data-line-number="12">  <span class="co"># Get Leverage</span></a>
<a class="sourceLine" id="cb58-13" data-line-number="13">  Hi &lt;-<span class="st"> </span><span class="kw">getLeverage</span>(x.cal.scores, x.val.scores)</a>
<a class="sourceLine" id="cb58-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb58-15" data-line-number="15">  <span class="co"># Get ResXValSamp</span></a>
<a class="sourceLine" id="cb58-16" data-line-number="16">  ResXValSamp &lt;-<span class="st"> </span><span class="kw">getResXValSamp</span>(PREDSET<span class="op">$</span>spc, REFSET<span class="op">$</span>spc, x.val.scores, loadings)</a>
<a class="sourceLine" id="cb58-17" data-line-number="17">  </a>
<a class="sourceLine" id="cb58-18" data-line-number="18">  <span class="co"># Get ResXValTot</span></a>
<a class="sourceLine" id="cb58-19" data-line-number="19">  ResXValTot &lt;-<span class="st"> </span><span class="kw">getTotResXCal</span>(REFSET<span class="op">$</span>spc, x.cal.scores, loadings)</a>
<a class="sourceLine" id="cb58-20" data-line-number="20">  </a>
<a class="sourceLine" id="cb58-21" data-line-number="21">  <span class="co"># Get ResYValVar</span></a>
<a class="sourceLine" id="cb58-22" data-line-number="22">  ResYValVar &lt;-<span class="st"> </span><span class="kw">MSEP</span>(MODEL, <span class="dt">intercept=</span><span class="ot">FALSE</span>)<span class="op">$</span>val[<span class="dv">1</span>,<span class="dv">1</span>,]</a>
<a class="sourceLine" id="cb58-23" data-line-number="23">  </a>
<a class="sourceLine" id="cb58-24" data-line-number="24">  <span class="co"># Get U-Deviation</span></a>
<a class="sourceLine" id="cb58-25" data-line-number="25">  udev &lt;-<span class="st"> </span><span class="kw">getYdev</span>(ResYValVar, ResXValSamp, ResXValTot, Hi, ncalobj)</a>
<a class="sourceLine" id="cb58-26" data-line-number="26">  </a>
<a class="sourceLine" id="cb58-27" data-line-number="27">  <span class="kw">return</span>(udev)</a>
<a class="sourceLine" id="cb58-28" data-line-number="28">  </a>
<a class="sourceLine" id="cb58-29" data-line-number="29">}</a></code></pre></div>
</div>
<div id="getydev" class="section level4 unnumbered">
<h4><code>getYdev()</code></h4>
<p>Performs the equation for the u-deviation, given input parameters.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" data-line-number="1"><span class="co"># Compute prediction error ydev</span></a>
<a class="sourceLine" id="cb59-2" data-line-number="2">getYdev &lt;-<span class="st"> </span><span class="cf">function</span>(ResYValVar, ResXValSamp, ResXValTot, Hi.pr, ncalobj){</a>
<a class="sourceLine" id="cb59-3" data-line-number="3">  nobj &lt;-<span class="st"> </span><span class="kw">dim</span>(ResXValSamp)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb59-4" data-line-number="4">  ncomp &lt;-<span class="st"> </span><span class="kw">dim</span>(ResXValSamp)[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb59-5" data-line-number="5">  ydev &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow=</span> nobj, <span class="dt">ncol=</span>ncomp)</a>
<a class="sourceLine" id="cb59-6" data-line-number="6">  <span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>ncomp){  </a>
<a class="sourceLine" id="cb59-7" data-line-number="7">    ydev[,i] &lt;-<span class="st"> </span><span class="kw">sqrt</span>(ResYValVar[i] <span class="op">*</span><span class="st"> </span>(ResXValSamp[,i]<span class="op">/</span>ResXValTot[i] <span class="op">+</span><span class="st"> </span>Hi[,i] <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">/</span>ncalobj) <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span><span class="op">-</span><span class="st"> </span>(i<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span>ncalobj))</a>
<a class="sourceLine" id="cb59-8" data-line-number="8">  }</a>
<a class="sourceLine" id="cb59-9" data-line-number="9">  <span class="kw">return</span>(ydev)</a>
<a class="sourceLine" id="cb59-10" data-line-number="10">}</a></code></pre></div>
</div>
<div id="getresxvalsamp" class="section level4 unnumbered">
<h4><code>getResXValSamp()</code></h4>
<p>Gets the residual variance for the prediction set spectra</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1">getResXValSamp &lt;-<span class="st"> </span><span class="cf">function</span>(x.val.mat,x.cal.mat,x.val.scores,x.cal.loadings){</a>
<a class="sourceLine" id="cb60-2" data-line-number="2">  nobj &lt;-<span class="st"> </span><span class="kw">dim</span>(x.val.mat)[<span class="dv">1</span>]                   <span class="co"># Number of samples in the prediction set</span></a>
<a class="sourceLine" id="cb60-3" data-line-number="3">  ncomp &lt;-<span class="st"> </span><span class="kw">dim</span>(x.val.scores)[<span class="dv">2</span>]               <span class="co"># Number of componenets in the model</span></a>
<a class="sourceLine" id="cb60-4" data-line-number="4">  npred &lt;-<span class="st"> </span><span class="kw">dim</span>(x.cal.loadings)[<span class="dv">1</span>]             <span class="co"># Number of spectral columns</span></a>
<a class="sourceLine" id="cb60-5" data-line-number="5">  res.val &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow=</span>nobj, <span class="dt">ncol=</span>ncomp) <span class="co"># Empty matrix [prediction set samples X number of components]</span></a>
<a class="sourceLine" id="cb60-6" data-line-number="6">  Xmeans.cal &lt;-<span class="st"> </span><span class="kw">colMeans</span>(x.cal.mat)           <span class="co"># Reference set means for each spectral column</span></a>
<a class="sourceLine" id="cb60-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb60-8" data-line-number="8">  <span class="co"># Subtracting Reference set spectral means from the prediction set spectral values</span></a>
<a class="sourceLine" id="cb60-9" data-line-number="9">  X.center &lt;-<span class="st"> </span>x.val.mat <span class="op">-</span><span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rep</span>(Xmeans.cal, <span class="dt">each =</span> nobj), <span class="dt">nrow=</span>nobj)</a>
<a class="sourceLine" id="cb60-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb60-11" data-line-number="11">  <span class="co"># For each component in the model...</span></a>
<a class="sourceLine" id="cb60-12" data-line-number="12">  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>ncomp){</a>
<a class="sourceLine" id="cb60-13" data-line-number="13">    x.fac.load.wts &lt;-<span class="st"> </span>x.val.scores[,<span class="dv">1</span><span class="op">:</span>i, drop=<span class="ot">FALSE</span>] <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(x.cal.loadings[,<span class="dv">1</span><span class="op">:</span>i,<span class="dt">drop=</span><span class="ot">FALSE</span>])</a>
<a class="sourceLine" id="cb60-14" data-line-number="14">    res.val[,i] &lt;-<span class="st"> </span><span class="kw">rowSums</span>((<span class="op">-</span>x.fac.load.wts <span class="op">+</span><span class="st"> </span>X.center)<span class="op">^</span><span class="dv">2</span>)<span class="op">/</span>(npred<span class="op">-</span>i) <span class="co"># Residual variance for prediction set spectra</span></a>
<a class="sourceLine" id="cb60-15" data-line-number="15">  }</a>
<a class="sourceLine" id="cb60-16" data-line-number="16">  <span class="kw">return</span>(res.val)</a>
<a class="sourceLine" id="cb60-17" data-line-number="17">}</a></code></pre></div>
</div>
<div id="gettotresxcal" class="section level4 unnumbered">
<h4><code>getTotResXCal()</code></h4>
<p>Gets the average residual variance for the reference/callibration set spectra.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" data-line-number="1">getTotResXCal &lt;-<span class="st"> </span><span class="cf">function</span>(x.cal.mat,x.cal.scores,x.cal.loadings){</a>
<a class="sourceLine" id="cb61-2" data-line-number="2">  nobj &lt;-<span class="st"> </span><span class="kw">dim</span>(x.cal.mat)[<span class="dv">1</span>]                   <span class="co"># Number of samples in the reference set</span></a>
<a class="sourceLine" id="cb61-3" data-line-number="3">  ncomp &lt;-<span class="st"> </span><span class="kw">dim</span>(x.cal.scores)[<span class="dv">2</span>]               <span class="co"># Number of components in the model</span></a>
<a class="sourceLine" id="cb61-4" data-line-number="4">  npred &lt;-<span class="st"> </span><span class="kw">dim</span>(x.cal.loadings)[<span class="dv">1</span>]             <span class="co"># Number of spectral columns</span></a>
<a class="sourceLine" id="cb61-5" data-line-number="5">  res.val &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow=</span>nobj, <span class="dt">ncol=</span>ncomp) <span class="co"># Empty matrix [reference set samples X number of components]</span></a>
<a class="sourceLine" id="cb61-6" data-line-number="6">  X.center &lt;-<span class="st"> </span><span class="kw">scale</span>(x.cal.mat, <span class="dt">scale=</span><span class="ot">FALSE</span>)   <span class="co"># Scaled reference set spectra</span></a>
<a class="sourceLine" id="cb61-7" data-line-number="7">  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>ncomp){</a>
<a class="sourceLine" id="cb61-8" data-line-number="8">    x.fac.load.wts &lt;-<span class="st"> </span>x.cal.scores[,<span class="dv">1</span><span class="op">:</span>i, drop=<span class="ot">FALSE</span>] <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(x.cal.loadings[,<span class="dv">1</span><span class="op">:</span>i,<span class="dt">drop=</span><span class="ot">FALSE</span>])</a>
<a class="sourceLine" id="cb61-9" data-line-number="9">    res.val[,i] &lt;-<span class="st"> </span><span class="kw">rowSums</span>((<span class="op">-</span>x.fac.load.wts <span class="op">+</span><span class="st"> </span>X.center)<span class="op">^</span><span class="dv">2</span>)<span class="op">/</span>(npred<span class="op">-</span>i) <span class="co"># Residual variance for refset spectra</span></a>
<a class="sourceLine" id="cb61-10" data-line-number="10">    </a>
<a class="sourceLine" id="cb61-11" data-line-number="11">  }</a>
<a class="sourceLine" id="cb61-12" data-line-number="12">  tot.res &lt;-<span class="st"> </span><span class="kw">colMeans</span>(res.val) <span class="co"># Average residual variance</span></a>
<a class="sourceLine" id="cb61-13" data-line-number="13">  <span class="kw">return</span>(tot.res)</a>
<a class="sourceLine" id="cb61-14" data-line-number="14">}</a></code></pre></div>
</div>
<div id="getleverage" class="section level4 unnumbered">
<h4><code>getLeverage()</code></h4>
<p>Gets the the distance of how far samples in the prediction set are from those in the reference set.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" data-line-number="1">getLeverage &lt;-<span class="st"> </span><span class="cf">function</span>(scores.calib, scores.valid){</a>
<a class="sourceLine" id="cb62-2" data-line-number="2">  ta.calib &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">crossprod</span>(scores.calib))</a>
<a class="sourceLine" id="cb62-3" data-line-number="3">  ta.calib1 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rep</span>(ta.calib, <span class="dt">each =</span> <span class="kw">nrow</span>(scores.valid)), <span class="dt">nrow=</span><span class="kw">nrow</span>(scores.valid))</a>
<a class="sourceLine" id="cb62-4" data-line-number="4">  ncal &lt;-<span class="st"> </span><span class="kw">dim</span>(scores.calib)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb62-5" data-line-number="5">  Hi &lt;-<span class="st"> </span>scores.valid<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>ta.calib1</a>
<a class="sourceLine" id="cb62-6" data-line-number="6">  ncomp &lt;-<span class="st"> </span><span class="kw">dim</span>(scores.valid)[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb62-7" data-line-number="7">  nobj &lt;-<span class="st"> </span><span class="kw">dim</span>(scores.valid)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb62-8" data-line-number="8">  Hi.pr &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow=</span>nobj, <span class="dt">ncol=</span>ncomp)</a>
<a class="sourceLine" id="cb62-9" data-line-number="9">  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>ncomp){</a>
<a class="sourceLine" id="cb62-10" data-line-number="10">    <span class="cf">if</span>(i <span class="op">==</span><span class="st"> </span><span class="dv">1</span>){</a>
<a class="sourceLine" id="cb62-11" data-line-number="11">      Hi.pr[,<span class="dv">1</span>] &lt;-<span class="st"> </span>Hi[,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb62-12" data-line-number="12">    }</a>
<a class="sourceLine" id="cb62-13" data-line-number="13">    <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb62-14" data-line-number="14">      Hi.pr[,i] &lt;-<span class="st"> </span><span class="kw">rowSums</span>(Hi[,<span class="dv">1</span><span class="op">:</span>i]) </a>
<a class="sourceLine" id="cb62-15" data-line-number="15">    }</a>
<a class="sourceLine" id="cb62-16" data-line-number="16">  }</a>
<a class="sourceLine" id="cb62-17" data-line-number="17">  Hi.pr &lt;-<span class="st"> </span>Hi.pr <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">/</span>ncal)</a>
<a class="sourceLine" id="cb62-18" data-line-number="18">  <span class="kw">return</span>(Hi.pr)</a>
<a class="sourceLine" id="cb62-19" data-line-number="19">}</a></code></pre></div>
</div>
</div>
</div>
<div id="plots" class="section level2 unnumbered">
<h2>Plots</h2>
<p>The following function creates a scatter plot of the observed lab data against the predictions, showing the line of best fit and its equation, as well as some summary statistics.</p>
<div id="plotpred" class="section level3 unnumbered">
<h3><code>plotPred()</code></h3>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" data-line-number="1">plotPred &lt;-<span class="st"> </span><span class="cf">function</span>(x,y, stats, <span class="dt">name=</span><span class="ot">NA</span>, <span class="dt">units=</span><span class="ot">NA</span>){</a>
<a class="sourceLine" id="cb63-2" data-line-number="2">  max &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">c</span>(x,y))</a>
<a class="sourceLine" id="cb63-3" data-line-number="3">  lims =<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>,(<span class="fl">1.1</span><span class="op">*</span>max))</a>
<a class="sourceLine" id="cb63-4" data-line-number="4">  <span class="kw">plot</span>(y <span class="op">~</span><span class="st"> </span>x, </a>
<a class="sourceLine" id="cb63-5" data-line-number="5">       <span class="dt">ylab =</span> <span class="kw">paste</span>(<span class="st">&quot;Predicted&quot;</span>, units), </a>
<a class="sourceLine" id="cb63-6" data-line-number="6">       <span class="dt">xlab=</span><span class="kw">paste</span>(<span class="st">&quot;Observed&quot;</span>, units), </a>
<a class="sourceLine" id="cb63-7" data-line-number="7">       <span class="dt">xlim =</span> lims,</a>
<a class="sourceLine" id="cb63-8" data-line-number="8">       <span class="dt">ylim=</span>lims,<span class="dt">main =</span> <span class="kw">paste</span>(name))</a>
<a class="sourceLine" id="cb63-9" data-line-number="9">  </a>
<a class="sourceLine" id="cb63-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb63-11" data-line-number="11">  reg_model &lt;-<span class="kw">lm</span>(y<span class="op">~</span>x)</a>
<a class="sourceLine" id="cb63-12" data-line-number="12">  <span class="kw">abline</span>(reg_model)</a>
<a class="sourceLine" id="cb63-13" data-line-number="13"></a>
<a class="sourceLine" id="cb63-14" data-line-number="14">  topstats &lt;-<span class="st"> </span><span class="kw">bquote</span>(R<span class="op">^</span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span>.(stats<span class="op">$</span>R2) <span class="op">*</span><span class="st"> &quot;,&quot;</span> <span class="op">~</span><span class="er">~</span><span class="kw">italic</span>(bias)<span class="op">==</span><span class="st"> </span>.(stats<span class="op">$</span>bias) <span class="op">*</span><span class="st"> &quot;,&quot;</span> <span class="op">~</span><span class="er">~</span><span class="st"> </span>RMSE <span class="op">==</span><span class="st"> </span>.(stats<span class="op">$</span>RMSE))</a>
<a class="sourceLine" id="cb63-15" data-line-number="15">  <span class="kw">text</span>(<span class="kw">min</span>(x,y),<span class="kw">max</span>(x,y), topstats, <span class="dt">pos =</span> <span class="dv">4</span>, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>)</a>
<a class="sourceLine" id="cb63-16" data-line-number="16">  </a>
<a class="sourceLine" id="cb63-17" data-line-number="17">  eqn &lt;-<span class="st"> </span><span class="kw">bquote</span>(y<span class="op">==</span><span class="st"> </span>.(stats<span class="op">$</span>Slope) <span class="op">*</span><span class="st"> &quot;x&quot;</span>  <span class="op">*</span><span class="st"> &quot; + &quot;</span> <span class="op">*</span><span class="st"> </span>.(stats<span class="op">$</span>Y_Int))</a>
<a class="sourceLine" id="cb63-18" data-line-number="18">  <span class="kw">text</span>(<span class="kw">min</span>(x,y),<span class="kw">max</span>(x,y)<span class="op">-</span>(<span class="kw">max</span>(x,y)<span class="op">-</span><span class="kw">min</span>(x,y))<span class="op">/</span><span class="dv">10</span>, eqn, <span class="dt">pos =</span> <span class="dv">4</span>, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>)</a>
<a class="sourceLine" id="cb63-19" data-line-number="19">}</a></code></pre></div>
<p><img src="images/predplot.png" /></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="mbl-models.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="mbl-ensemble-approach.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "sepia",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
