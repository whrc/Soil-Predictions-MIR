<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 PLSR Models | Soil Predictions using MIR-Spectroscopy</title>
  <meta name="description" content="5 PLSR Models | Soil Predictions using MIR-Spectroscopy" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="5 PLSR Models | Soil Predictions using MIR-Spectroscopy" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 PLSR Models | Soil Predictions using MIR-Spectroscopy" />
  
  
  

<meta name="author" content="Charlotte Rivard" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data-preprocessing.html"/>
<link rel="next" href="mbl-models.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Soil Predictions using MIR-Spectroscopy</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="background.html"><a href="background.html"><i class="fa fa-check"></i><b>2</b> Background</a></li>
<li class="chapter" data-level="3" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>3</b> Getting Started</a><ul>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#file-walkthrough"><i class="fa fa-check"></i>File Walkthrough</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#required-packages"><i class="fa fa-check"></i>Required Packages</a><ul>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#simplerspec"><i class="fa fa-check"></i>simplerspec</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#stringr"><i class="fa fa-check"></i>stringr</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#foreach"><i class="fa fa-check"></i>foreach</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#prospectr"><i class="fa fa-check"></i>prospectr</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#clhs"><i class="fa fa-check"></i>clhs</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#matrixstats"><i class="fa fa-check"></i>matrixStats</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#plot3d"><i class="fa fa-check"></i>plot3D</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#pls"><i class="fa fa-check"></i>pls</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#resemble"><i class="fa fa-check"></i>resemble</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#demo-script"><i class="fa fa-check"></i>Demo Script</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-preprocessing.html"><a href="data-preprocessing.html"><i class="fa fa-check"></i><b>4</b> Data Preprocessing</a><ul>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#get-spectral-library"><i class="fa fa-check"></i>Get Spectral Library</a><ul>
<li><a href="data-preprocessing.html#getspeclib"><code>getSpecLib()</code></a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#extract-spectra"><i class="fa fa-check"></i>Extract Spectra</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#process-spectra"><i class="fa fa-check"></i>Process Spectra</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#merge-with-lab-data"><i class="fa fa-check"></i>Merge with Lab Data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#refine-spectral-library"><i class="fa fa-check"></i>Refine Spectral Library</a><ul>
<li><a href="data-preprocessing.html#refinespeclib"><code>refineSpecLib()</code></a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#large-sets"><i class="fa fa-check"></i>Large Sets</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#faulty-lab-data"><i class="fa fa-check"></i>Faulty Lab Data</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#outliers"><i class="fa fa-check"></i>Outliers</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#calval-groups"><i class="fa fa-check"></i>Cal/Val Groups</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="plsr-models.html"><a href="plsr-models.html"><i class="fa fa-check"></i><b>5</b> PLSR Models</a><ul>
<li class="chapter" data-level="" data-path="plsr-models.html"><a href="plsr-models.html#model-theory"><i class="fa fa-check"></i>Model Theory</a></li>
<li class="chapter" data-level="" data-path="plsr-models.html"><a href="plsr-models.html#making-plsr-models"><i class="fa fa-check"></i>Making PLSR Models</a><ul>
<li><a href="plsr-models.html#makeplsmodel"><code>makePLSModel()</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="plsr-models.html"><a href="plsr-models.html#getting-pls-predictions"><i class="fa fa-check"></i>Getting PLS Predictions</a><ul>
<li><a href="plsr-models.html#getpredpls"><code>getPredPLS()</code></a></li>
<li><a href="plsr-models.html#ncomponesigma"><code>ncompOneSigma()</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="mbl-models.html"><a href="mbl-models.html"><i class="fa fa-check"></i><b>6</b> MBL Models</a><ul>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#model-theory-1"><i class="fa fa-check"></i>Model Theory</a><ul>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#overview"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#animation"><i class="fa fa-check"></i>Animation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#running-mbl"><i class="fa fa-check"></i>Running MBL</a><ul>
<li><a href="mbl-models.html#runmbl"><code>runMBL()</code></a></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#modeling-parameters"><i class="fa fa-check"></i>Modeling Parameters</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#getting-mbl-predictions"><i class="fa fa-check"></i>Getting MBL Predictions</a><ul>
<li><a href="mbl-models.html#bestmodmbl"><code>bestModMBL()</code></a></li>
<li><a href="mbl-models.html#getpredmbl"><code>getPredMBL()</code></a></li>
<li><a href="mbl-models.html#getlabmbl"><code>getLabMBL()</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="model-performance.html"><a href="model-performance.html"><i class="fa fa-check"></i><b>7</b> Model Performance</a><ul>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#get-results"><i class="fa fa-check"></i>Get Results</a><ul>
<li><a href="model-performance.html#getmodresults"><code>getModResults()</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#predictions"><i class="fa fa-check"></i>Predictions</a><ul>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#getsavepredtable"><i class="fa fa-check"></i>getSavePredTable()</a></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#savepredictions"><i class="fa fa-check"></i>savePredictions()</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#statistics"><i class="fa fa-check"></i>Statistics</a><ul>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#getmodstats"><i class="fa fa-check"></i>getModStats()</a></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#savemodstats"><i class="fa fa-check"></i>saveModStats()</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#plots"><i class="fa fa-check"></i>Plots</a><ul>
<li><a href="model-performance.html#plotpred"><code>plotPred()</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Soil Predictions using MIR-Spectroscopy</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="plsr-models" class="section level1">
<h1><span class="header-section-number">5</span> PLSR Models</h1>
<p>This section of the <a href="https://whrc.github.io/Soil-Predictions-MIR/getting-started.html#demo-script">demo script</a> creates PLSR models and gets predictions from them:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="co">#----------------------------------------------#</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2"><span class="co"># Partial Least Squares Regression #</span></a>
<a class="sourceLine" id="cb26-3" data-line-number="3"><span class="co">#----------------------------------------------#</span></a>
<a class="sourceLine" id="cb26-4" data-line-number="4"><span class="kw">source</span>(<span class="st">&quot;Functions/plsr_functions.R&quot;</span>)</a>
<a class="sourceLine" id="cb26-5" data-line-number="5"><span class="kw">source</span>(<span class="st">&quot;Functions/perform_functions.R&quot;</span>)</a>
<a class="sourceLine" id="cb26-6" data-line-number="6"></a>
<a class="sourceLine" id="cb26-7" data-line-number="7"><span class="co"># Make Model</span></a>
<a class="sourceLine" id="cb26-8" data-line-number="8">plsr.OC &lt;-<span class="st"> </span><span class="kw">makePLSModel</span>(<span class="dt">PROP=</span><span class="st">&quot;OC&quot;</span>, <span class="dt">REFNAME=</span><span class="st">&quot;refSet&quot;</span>)</a>
<a class="sourceLine" id="cb26-9" data-line-number="9"></a>
<a class="sourceLine" id="cb26-10" data-line-number="10"><span class="co"># Make Predictions</span></a>
<a class="sourceLine" id="cb26-11" data-line-number="11">pls.predictions &lt;-<span class="st"> </span><span class="kw">getModResults</span>(<span class="dt">PROP=</span><span class="st">&quot;OC&quot;</span>, <span class="dt">MODTYPE=</span><span class="st">&quot;PLS&quot;</span>, <span class="dt">MODNAME=</span> <span class="st">&quot;plsr.OC&quot;</span>, <span class="dt">PREDNAME=</span> <span class="st">&quot;predSet&quot;</span>)</a></code></pre></div>
<div id="model-theory" class="section level2 unnumbered">
<h2>Model Theory</h2>
<ul>
<li><strong>Partial Least Squares Regression</strong> (PLSR) is a useful technique for making predictions on high dimensional datasets; Those with many columns or predictor variables relative to the number of rows or instances.
<ul>
<li>For example, we are using <strong>2720 columns</strong> of spectral data as predictor variables for only <strong>478 rows</strong> of samples in the script to follow. This could cause major issues of overfitting with a simple regression and there may be a lot of redundancy in the data.</li>
</ul></li>
<li>PLSR models, like Principal Component Analysis (PCA), <strong>reduce the dimensionality</strong> of the dataset by creating a new set of orthogonal variables that explain the most variation in the data called principal components.
<ul>
<li>Scores: Scores are the location (or distance from origin) of each sample along each principal component. Represented by U in the diagram below.</li>
<li>Loadings: Loadings are the weights of each of the original variables (wavenumbers) used to calculate each principal component. Represented by V in the diagram below.</li>
</ul>
<p><img src="images/pls_theory.png" /><a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a></p></li>
<li>However, instead of <strong>optimizing covariance</strong> amoung only the predictor variables, in this case the spectra, PLS optimizes covariance between the predictors and the response variable, the soil property of interest.
<ul>
<li>To learn more about PLS, check out this youtube video: <a href="%22https://www.youtube.com/watch?v=AxmqUKYeD-U%22"><strong>PLS Introductory Video</strong></a></li>
</ul></li>
</ul>
<!-- These come in the form of scores and loadings {explain contrast with PCA} -->
<!--vocab: orthogonal, high dimensional, latent variables- have links to define orthogonal-->
</div>
<div id="making-plsr-models" class="section level2 unnumbered">
<h2>Making PLSR Models</h2>
<p>The following is a wrapper function for loading the appropriate data, assigning a validation type, making a PLS model and optionally saving it. It is stored in <code>Functions/plsr_functions.R</code> and used directly in the <a href="https://whrc.github.io/Soil-Predictions-MIR/getting-started.html#demo-script">demo script</a>:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">source</span>(<span class="st">&quot;Functions/plsr_functions.R&quot;</span>)</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="co"># Make Model</span></a>
<a class="sourceLine" id="cb27-3" data-line-number="3">plsr.OC &lt;-<span class="st"> </span><span class="kw">makePLSModel</span>(<span class="dt">PROP=</span><span class="st">&quot;OC&quot;</span>, <span class="dt">REFNAME=</span><span class="st">&quot;refSet&quot;</span>)</a></code></pre></div>
<div id="makeplsmodel" class="section level3 unnumbered">
<h3><code>makePLSModel()</code></h3>
<ul>
<li><code>makePLSModel( PROP, REFNAME, REFPATH, VAL_TYPE, SAVENAME )</code>
<ul>
<li><code>PROP</code>: <em>string</em>- The column name of soil property of interest in your reference set</li>
<li><code>REFNAME</code>: <em>string</em>- The name of the reference set variable, if it is already loaded into the R environment, that will be used to create the model. Use REFNAME or REFPATH</li>
<li><code>REFPATH</code>: <em>string</em>- The path the the RData file containing your reference set, if the reference set is not already loaded. Use REFNAME or REFPATH</li>
<li><code>VALTYPE</code>: <em>string</em>- {Optional} The validation method, either “LOO”, CV“, or”none“. The default is set to”CV&quot;</li>
<li><code>SAVENAME</code>: <em>string</em>- {Optional} The name you would like to save the spectral file after processing. The default is set to <code>paste0(&quot;plsr.&quot;,PROP)</code> which would save the file “plsr.OC.RData”, for example</li>
</ul></li>
</ul>
<p>_</p>
<ul>
<li>We use the <a href="https://cran.r-project.org/web/packages/pls/vignettes/pls-manual.pdf">pls package in r…</a></li>
</ul>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="co">#---Packages---#</span></a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="kw">library</span>(pls)</a></code></pre></div>
<ul>
<li>If <code>REFPATH</code> is not NA, it will load the reference set at the path passed. Otherwise, it assumes you have passed in <code>REFNAME</code>, the variable name of a reference set already loaded. We use the <code>get()</code> command, rather than the variable itself, so that the name of the variable can be saved with our prediction performance.</li>
</ul>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="co"># Load Data</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(REFPATH)){</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">  REFNAME &lt;-<span class="st"> </span><span class="kw">load</span>(REFPATH) <span class="co"># If REFPATH is given</span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb29-5" data-line-number="5">refset &lt;-<span class="st"> </span><span class="kw">get</span>(REFNAME) <span class="co"># load as variable REFSET</span></a></code></pre></div>
<ul>
<li><p>The <code>plsr()</code> command creates a model based on several inputs, outlined in the
full <a href="https://www.rdocumentation.org/packages/pls/versions/2.7-2/topics/mvr"><strong>plsr() documentation</strong></a> and <a href="https://cran.r-project.org/web/packages/pls/pls.pdf"><strong>pls manual</strong></a></p></li>
<li>Used in this example we have…
<ul>
<li><code>Y</code> The lab data/ observed data for the soil property you are trying to predict. We chose to square root transform this variable to normalize the data. Predictions made my the model are squared to back transform them.<br />
</li>
<li><code>X</code> A matrix of spectra with the same number of rows as Y<br />
</li>
<li><code>ncomp</code> The number of components that you would like to include in the model<br />
</li>
<li><code>data</code> The dataset containing Y and X<br />
</li>
<li><code>valid</code> The preferred validation type (“LOO”,“CV”,“none”)
<ul>
<li><code>LOO</code> for leave-one out</li>
<li><code>CV</code> for cross validation</li>
<li><code>none</code> if you chose not to include validation</li>
</ul></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="co"># Create Model</span></a>
<a class="sourceLine" id="cb30-2" data-line-number="2">model &lt;-<span class="st"> </span><span class="kw">plsr</span>(<span class="kw">sqrt</span>(<span class="kw">get</span>(PROP))<span class="op">~</span>spc, <span class="dt">ncomp=</span><span class="dv">20</span>, <span class="dt">data =</span> refset , <span class="dt">valid=</span>VALTYPE)</a></code></pre></div>
<ul>
<li>Optionally save the model. By default it will save to the Models folder as plsr.PROP -&gt; Ex: ‘Models/plsr.OC.RData’</li>
</ul>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="co"># Save Model</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="cf">if</span>(SAVENAME <span class="op">!=</span><span class="st"> &quot;none&quot;</span>){</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">  <span class="cf">if</span>(<span class="kw">file.exists</span>(<span class="st">&quot;./Models&quot;</span>)<span class="op">==</span><span class="ot">FALSE</span>){<span class="kw">dir.create</span>(<span class="st">&quot;./Models&quot;</span>)} <span class="co"># Create Folder to Save Models</span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4">  <span class="kw">assign</span>(SAVENAME, model)</a>
<a class="sourceLine" id="cb31-5" data-line-number="5">  savefile &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Models/&quot;</span>,SAVENAME,<span class="st">&quot;.RData&quot;</span>)</a>
<a class="sourceLine" id="cb31-6" data-line-number="6">  <span class="kw">save</span>(<span class="dt">list=</span> SAVENAME, <span class="dt">file =</span> savefile) <span class="co">#Ex: plsr.OC.RData</span></a>
<a class="sourceLine" id="cb31-7" data-line-number="7">  <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Model saved to&quot;</span>,savefile))</a>
<a class="sourceLine" id="cb31-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb31-9" data-line-number="9"><span class="kw">return</span>(model)</a></code></pre></div>
</div>
</div>
<div id="getting-pls-predictions" class="section level2 unnumbered">
<h2>Getting PLS Predictions</h2>
<p>The following is a function for getting PLS predictions stored in <code>Functions/plsr_functions.R</code> In the <a href="https://whrc.github.io/Soil-Predictions-MIR/getting-started.html#demo-script">demo script</a> is it called within <code>getModResults()</code> which is stored in <code>Functions/perform_functions.R</code>.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">pls.predictions &lt;-<span class="st"> </span><span class="kw">getModResults</span>(<span class="dt">PROP=</span><span class="st">&quot;OC&quot;</span>, <span class="dt">MODTYPE=</span><span class="st">&quot;PLS&quot;</span>, <span class="dt">MODNAME=</span> <span class="st">&quot;plsr.OC&quot;</span>, <span class="dt">PREDNAME=</span> <span class="st">&quot;predSet&quot;</span>)</a></code></pre></div>
<div id="getpredpls" class="section level3 unnumbered">
<h3><code>getPredPLS()</code></h3>
<p>There are a few different ways of getting predictions from a pls model. Stored within the pls object itself, are the validation predictions and fitted predictions for the reference set used to build the model. However, you can also apply the model on a new dataset using the <code>predict()</code> function in the pls package.</p>
<ul>
<li><code>getPredPLS( MODEL, NCOMP, PREDTYPE, PREDSET )</code>
<ul>
<li><code>MODEL</code>: <em>object</em>- pls model object to get predictions from</li>
<li><code>NCOMP</code>: <em>integer</em>- Number of components of the model to use for getting predictions. Default is set to <code>ncompOneSigma()</code></li>
<li><code>PREDTYPE</code>: <em>string</em>- The prediction method, “fitted” returns the predictions for the reference set, “valid” returns the validation predictions for the reference set, and “predict” will return predictions from applying the model on another dataset, PREDSET.<br />
</li>
<li><code>PREDSET</code>: <em>dataframe</em>- A dataframe to apply the model on to make predictions. Must have a ‘spc’ column containing a matrix of spectral data with the same number of columns as the reference set used to build the original model.<br />
_</li>
</ul></li>
<li>If the prediction type is “valid”, we extract the validation predictions for the reference set, made when creating the model. These are stored within the model object at <code>MODEL$validation$pred</code></li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="cf">if</span>(PREDTYPE<span class="op">==</span><span class="st">&quot;valid&quot;</span>){</a>
<a class="sourceLine" id="cb33-2" data-line-number="2">  sqrt_pred &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">data.frame</span>(MODEL<span class="op">$</span>validation<span class="op">$</span>pred)[NCOMP])</a>
<a class="sourceLine" id="cb33-3" data-line-number="3">}</a></code></pre></div>
<ul>
<li>If the prediction type is “fitted”, we extract the predictions from the reference set. These are the fitted values of the reference set to the model and are stored within the model at <code>MODEL$fitted.values</code></li>
</ul>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="cf">if</span>(PREDTYPE <span class="op">==</span><span class="st"> &quot;fitted&quot;</span>){</a>
<a class="sourceLine" id="cb34-2" data-line-number="2">  sqrt_pred &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">data.frame</span>(MODEL<span class="op">$</span>fitted.values)[NCOMP])</a>
<a class="sourceLine" id="cb34-3" data-line-number="3">}</a></code></pre></div>
<ul>
<li>If the prediction type is “predict”, we make predictions with off of the spectra in our prediction set.</li>
</ul>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="cf">if</span>(PREDTYPE <span class="op">==</span><span class="st"> &quot;predict&quot;</span>){</a>
<a class="sourceLine" id="cb35-2" data-line-number="2">  sqrt_pred &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">predict</span>(MODEL, <span class="dt">newdata =</span> PREDSET<span class="op">$</span>spc, <span class="dt">ncomp=</span>NCOMP))</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">}</a></code></pre></div>
<ul>
<li>Since we square root transformed the input lab data, we actually predicted for the square root of our property of interest. Here we square the predictions to untransform this data.</li>
</ul>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">predictions &lt;-<span class="st"> </span><span class="kw">c</span>(sqrt_pred<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb36-2" data-line-number="2"><span class="kw">names</span>(predictions) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(predictions)))</a>
<a class="sourceLine" id="cb36-3" data-line-number="3"><span class="kw">return</span>(predictions)</a></code></pre></div>
</div>
<div id="ncomponesigma" class="section level3 unnumbered">
<h3><code>ncompOneSigma()</code></h3>
<p>This function selects the optimal number of components to use for getting pls predictions from the model.</p>
<ul>
<li><code>ncompOneSigma( MODEL )</code>
<ul>
<li><code>MODEL</code>: A PLS model object</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">ncompOneSigma &lt;-<span class="st"> </span><span class="cf">function</span>(MODEL){</a>
<a class="sourceLine" id="cb37-2" data-line-number="2">  ncomp &lt;-<span class="st"> </span><span class="kw">selectNcomp</span>(MODEL, <span class="dt">method =</span> <span class="st">&quot;onesigma&quot;</span>, <span class="dt">plot =</span> <span class="ot">TRUE</span>, <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">50</span>))</a>
<a class="sourceLine" id="cb37-3" data-line-number="3">  <span class="kw">return</span>(ncomp)</a>
<a class="sourceLine" id="cb37-4" data-line-number="4">}</a></code></pre></div>
<p>The scree plot below shows how much the RMSEP decreases, with each additional component added. As you can see, the marginal improvements to the model eventually level off, and the addition of more components is not necessary for better predictions. With the method “onesigma”, the optimal number of components is selected as the first model where the RMSEP is within 1 standard error of the absolute optimal RMSEP.<br />
<img src="images/scree-plot.png" /></p>
<!-- #----------------Optional Functions------------------#

# Get Sample ID

getSampleID <- function(PROPERTY, PREDTYPE, PREDSET=NULL, REFSET=NULL){
  if(PREDTYPE == "predict"){
    sample_id <- data.frame(PREDSET$sample_id)
  }
  else{ # If predtype is "valid" or "fitted"
    sample_id <- data.frame(REFSET$sample_id)
  }
  names(sample_id) <- c("sample_id")
  return(sample_id)
}


# Get Lab Data

getLabPLS<- function(MODEL, PREDTYPE="fitted", PREDSET=NULL, PROP=NULL){

  # Extract Lab Data
  if(PREDTYPE=="predict"){
    lab_data <- c(PREDSET[,PROP])
  }else{
    Y_name <- names(MODEL$model)[1]
    print(Y_name)
    sqrt_lab <- eval(parse( text=paste0("MODEL$model$`", Y_name,"`")))
    #lab_data <- data.frame(MODEL$model$`sqrt(get(property))`^2)
    lab_data <- c(sqrt_lab)^2
  }

  return(lab_data)
}


# Get PLS Model Coefficients

getPLSCoefs <- function(MODEL, PROP, NCOMP){
  beta_coeff <- data.frame(MODEL$coefficients)[NCOMP]
  return(beta_coeff)
}
-->

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="2">
<li id="fn2"><p><a href="http://www.statistics4u.com/fundstat_eng/cc_pca_loadscore.html" class="uri">http://www.statistics4u.com/fundstat_eng/cc_pca_loadscore.html</a><a href="plsr-models.html#fnref2" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data-preprocessing.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="mbl-models.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "sepia",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
