<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Data Preprocessing | Soil Predictions using MIR-Spectroscopy</title>
  <meta name="description" content="4 Data Preprocessing | Soil Predictions using MIR-Spectroscopy" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Data Preprocessing | Soil Predictions using MIR-Spectroscopy" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Data Preprocessing | Soil Predictions using MIR-Spectroscopy" />
  
  
  

<meta name="author" content="Charlotte Rivard" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="getting-started.html"/>
<link rel="next" href="plsr-models.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Soil Predictions using MIR-Spectroscopy</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="background.html"><a href="background.html"><i class="fa fa-check"></i><b>2</b> Background</a></li>
<li class="chapter" data-level="3" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>3</b> Getting Started</a><ul>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#file-walkthrough"><i class="fa fa-check"></i>File Walkthrough</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#required-packages"><i class="fa fa-check"></i>Required Packages</a><ul>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#simplerspec"><i class="fa fa-check"></i>simplerspec</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#stringr"><i class="fa fa-check"></i>stringr</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#foreach"><i class="fa fa-check"></i>foreach</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#prospectr"><i class="fa fa-check"></i>prospectr</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#clhs"><i class="fa fa-check"></i>clhs</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#matrixstats"><i class="fa fa-check"></i>matrixStats</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#plot3d"><i class="fa fa-check"></i>plot3D</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#pls"><i class="fa fa-check"></i>pls</a></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#resemble"><i class="fa fa-check"></i>resemble</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="getting-started.html"><a href="getting-started.html#demo-script"><i class="fa fa-check"></i>Demo Script</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-preprocessing.html"><a href="data-preprocessing.html"><i class="fa fa-check"></i><b>4</b> Data Preprocessing</a><ul>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#get-spectral-library"><i class="fa fa-check"></i>Get Spectral Library</a><ul>
<li><a href="data-preprocessing.html#getspeclib"><code>getSpecLib()</code></a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#extract-spectra"><i class="fa fa-check"></i>Extract Spectra</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#process-spectra"><i class="fa fa-check"></i>Process Spectra</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#merge-with-lab-data"><i class="fa fa-check"></i>Merge with Lab Data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#refine-spectral-library"><i class="fa fa-check"></i>Refine Spectral Library</a><ul>
<li><a href="data-preprocessing.html#refinespeclib"><code>refineSpecLib()</code></a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#large-sets"><i class="fa fa-check"></i>Large Sets</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#faulty-lab-data"><i class="fa fa-check"></i>Faulty Lab Data</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#outliers"><i class="fa fa-check"></i>Outliers</a></li>
<li class="chapter" data-level="" data-path="data-preprocessing.html"><a href="data-preprocessing.html#calval-groups"><i class="fa fa-check"></i>Cal/Val Groups</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="plsr-models.html"><a href="plsr-models.html"><i class="fa fa-check"></i><b>5</b> PLSR Models</a><ul>
<li class="chapter" data-level="" data-path="plsr-models.html"><a href="plsr-models.html#model-theory"><i class="fa fa-check"></i>Model Theory</a></li>
<li class="chapter" data-level="" data-path="plsr-models.html"><a href="plsr-models.html#making-plsr-models"><i class="fa fa-check"></i>Making PLSR Models</a><ul>
<li><a href="plsr-models.html#makeplsmodel"><code>makePLSModel()</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="plsr-models.html"><a href="plsr-models.html#getting-pls-predictions"><i class="fa fa-check"></i>Getting PLS Predictions</a><ul>
<li><a href="plsr-models.html#getpredpls"><code>getPredPLS()</code></a></li>
<li><a href="plsr-models.html#ncomponesigma"><code>ncompOneSigma()</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="mbl-models.html"><a href="mbl-models.html"><i class="fa fa-check"></i><b>6</b> MBL Models</a><ul>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#model-theory-1"><i class="fa fa-check"></i>Model Theory</a><ul>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#overview"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#animation"><i class="fa fa-check"></i>Animation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#running-mbl"><i class="fa fa-check"></i>Running MBL</a><ul>
<li><a href="mbl-models.html#runmbl"><code>runMBL()</code></a></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#modeling-parameters"><i class="fa fa-check"></i>Modeling Parameters</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mbl-models.html"><a href="mbl-models.html#getting-mbl-predictions"><i class="fa fa-check"></i>Getting MBL Predictions</a><ul>
<li><a href="mbl-models.html#bestmodmbl"><code>bestModMBL()</code></a></li>
<li><a href="mbl-models.html#getpredmbl"><code>getPredMBL()</code></a></li>
<li><a href="mbl-models.html#getlabmbl"><code>getLabMBL()</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="model-performance.html"><a href="model-performance.html"><i class="fa fa-check"></i><b>7</b> Model Performance</a><ul>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#get-results"><i class="fa fa-check"></i>Get Results</a><ul>
<li><a href="model-performance.html#getmodresults"><code>getModResults()</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#predictions"><i class="fa fa-check"></i>Predictions</a><ul>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#getsavepredtable"><i class="fa fa-check"></i>getSavePredTable()</a></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#savepredictions"><i class="fa fa-check"></i>savePredictions()</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#statistics"><i class="fa fa-check"></i>Statistics</a><ul>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#getmodstats"><i class="fa fa-check"></i>getModStats()</a></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#savemodstats"><i class="fa fa-check"></i>saveModStats()</a></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#calcudev"><i class="fa fa-check"></i>calcUDev()</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-performance.html"><a href="model-performance.html#plots"><i class="fa fa-check"></i>Plots</a><ul>
<li><a href="model-performance.html#plotpred"><code>plotPred()</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="mbl-ensemble-approach.html"><a href="mbl-ensemble-approach.html"><i class="fa fa-check"></i><b>8</b> MBL Ensemble Approach</a><ul>
<li class="chapter" data-level="" data-path="mbl-ensemble-approach.html"><a href="mbl-ensemble-approach.html#model-iterations"><i class="fa fa-check"></i>Model Iterations</a></li>
<li class="chapter" data-level="" data-path="mbl-ensemble-approach.html"><a href="mbl-ensemble-approach.html#getting-started-1"><i class="fa fa-check"></i>Getting started</a><ul>
<li class="chapter" data-level="" data-path="mbl-ensemble-approach.html"><a href="mbl-ensemble-approach.html#file-walkthrough-1"><i class="fa fa-check"></i>File Walkthrough</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Soil Predictions using MIR-Spectroscopy</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-preprocessing" class="section level1">
<h1><span class="header-section-number">4</span> Data Preprocessing</h1>
<p>This section of the <a href="https://whrc.github.io/Soil-Predictions-MIR/getting-started.html#demo-script">demo script</a> preprocesses the spectral and lab data that will be used to make models and predictions from. The following subsections explain the steps of preprocessing and their respective functions in more detail</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">#----------------------------------------------#</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co"># Data Preprocessing #</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#----------------------------------------------#</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">source</span>(<span class="st">&quot;Functions/preprocess_functions.R&quot;</span>)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co"># Get Spectral Library Set</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">ALL_data &lt;-<span class="st"> </span><span class="kw">getSpecLib</span>(<span class="dt">SAVENAME=</span><span class="st">&quot;ALL_data&quot;</span>)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co"># Refine Spectral Library</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">OC_data &lt;-<span class="st"> </span><span class="kw">refineSpecLib</span>(<span class="dt">SPECLIB=</span>ALL_data, <span class="dt">PROP=</span><span class="st">&quot;OC&quot;</span>, <span class="dt">CALVAL=</span><span class="ot">TRUE</span>, <span class="dt">SAVENAME=</span><span class="st">&quot;OC_data&quot;</span>)</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co"># Define Reference and Prediction Sets</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#load(&quot;Data_Processed/OC_data.RData&quot;)</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">refSet &lt;-<span class="st"> </span>OC_data[OC_data<span class="op">$</span>calib<span class="op">==</span><span class="dv">1</span>,]</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">predSet &lt;-<span class="st"> </span>OC_data[OC_data<span class="op">$</span>calib<span class="op">==</span><span class="dv">0</span>,]</a></code></pre></div>
<ul>
<li>Data Preprocessing must be performed for the <strong>reference set</strong>, used to create the models, as well as the dataset you are making predictions from, the <strong>prediction set</strong></li>
<li>The prediction set and reference set will be the same dataset if you are just using a <strong>single spectral library</strong>, but can be different if you are using models from one set to make predictions on another.</li>
<li>Data preprocesing is executed by the functions within <code>preprocess_functions.R</code></li>
</ul>
<div id="get-spectral-library" class="section level2 unnumbered">
<h2>Get Spectral Library</h2>
<p>A <strong>spectral library</strong> is simply a dataset containing spectral data for various samples. For the purpose of training models, it is also necessary to have corresponding lab data for the soil properties you are interested in predicting. <code>getSpecLib()</code> is a wrapper function that takes a folder of OPUS files containing spectral data, and a ‘csv’ of lab data, and outputs a merged file with all the spectral and lab data for each sample.</p>
<div id="getspeclib" class="section level3 unnumbered">
<h3><code>getSpecLib()</code></h3>
<ul>
<li><code>getSpecLib( SPECPATH, LABPATH, SAVENAME )</code>
<ul>
<li><code>SPECPATH</code>: <em>string</em>- The path to the folder of opus files, from within the ‘Soil-Predictions-Example’ folder. Default set to “/Data_Raw/SPECTRA”</li>
<li><code>LABPATH</code>: <em>string</em>- The path to the ‘csv’ of lab data. This file must include a sample_id column first, followed by the column(s) of lab data for the soil properties of interest. sample_id will be used to merge the spectra to its corresponding lab data</li>
<li><code>SAVENAME</code>: <em>string</em>- The name you would like to save the spectral file after processing. The default is set to “none” which will not save a file.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">getSpecLib &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">SPECPATH=</span><span class="st">&quot;/Data_Raw/SPECTRA&quot;</span>, </a>
<a class="sourceLine" id="cb4-2" data-line-number="2">                       <span class="dt">LABPATH=</span><span class="st">&quot;Data_Raw/LAB_DATA.csv&quot;</span>, <span class="dt">SAVENAME=</span><span class="st">&quot;none&quot;</span>){</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="co"># Extract OPUS Files</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  spectra &lt;-<span class="st"> </span><span class="kw">opus_to_dataset</span>(SPECPATH)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  <span class="co"># Subset Spectral Range</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">  spectra<span class="op">$</span>spc &lt;-<span class="st"> </span><span class="kw">subset_spectral_range</span>(spectra<span class="op">$</span>spc)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb4-9" data-line-number="9">  <span class="co"># Where calibration transfer would occur</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb4-11" data-line-number="11">  <span class="co"># Baseline Transformation</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">  spectra<span class="op">$</span>spc &lt;-<span class="st"> </span><span class="kw">base_offset</span>(spectra<span class="op">$</span>spc)</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">  </a>
<a class="sourceLine" id="cb4-14" data-line-number="14">  <span class="co"># Merge with Lab Data</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">  lab &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">read.csv</span>(LABPATH))</a>
<a class="sourceLine" id="cb4-16" data-line-number="16">  speclib &lt;-<span class="st"> </span><span class="kw">merge</span>(lab, spectra, <span class="dt">all.y=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb4-17" data-line-number="17">  </a>
<a class="sourceLine" id="cb4-18" data-line-number="18">  <span class="co"># Optional Save after Processing</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19">  <span class="cf">if</span>(SAVENAME<span class="op">!=</span><span class="st"> &quot;none&quot;</span>){</a>
<a class="sourceLine" id="cb4-20" data-line-number="20">    <span class="kw">assign</span>(SAVENAME,speclib)</a>
<a class="sourceLine" id="cb4-21" data-line-number="21">    speclib &lt;-<span class="st"> </span><span class="kw">get</span>(SAVENAME)</a>
<a class="sourceLine" id="cb4-22" data-line-number="22">    <span class="cf">if</span>(<span class="kw">file.exists</span>(<span class="st">&quot;./Data_Processed&quot;</span>)<span class="op">==</span><span class="ot">FALSE</span>){<span class="kw">dir.create</span>(<span class="st">&quot;./Data_Processed&quot;</span>)}</a>
<a class="sourceLine" id="cb4-23" data-line-number="23">    savepath &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Data_Processed/&quot;</span>,SAVENAME,<span class="st">&quot;.RData&quot;</span>)</a>
<a class="sourceLine" id="cb4-24" data-line-number="24">    <span class="kw">save</span>(speclib, <span class="dt">file=</span>savepath)</a>
<a class="sourceLine" id="cb4-25" data-line-number="25">    <span class="kw">write.csv</span>(speclib, savepath, <span class="dt">row.names=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb4-26" data-line-number="26">  }</a>
<a class="sourceLine" id="cb4-27" data-line-number="27">  <span class="kw">return</span>(speclib)</a>
<a class="sourceLine" id="cb4-28" data-line-number="28">}</a></code></pre></div>
<div class="figure">
<img src="images/ref.ALL.png" alt="Output Dataset" />
<p class="caption">Output Dataset</p>
</div>
</div>
<div id="extract-spectra" class="section level3 unnumbered">
<h3>Extract Spectra</h3>
<p>For Bruker Instruments, an <strong>OPUS file</strong> containing spectral data, will be output for each sample that is scanned. To compile these separate files into one dataset, we use a couple functions from the <code>simplerspc</code> package by Philip Baumann, as well as the <code>stringr</code> and <code>foreach</code> packages.</p>
<div id="opus_to_dataset" class="section level4 unnumbered">
<h4><code>opus_to_dataset()</code></h4>
<ul>
<li><code>opus_to_dataset( SPECPATH, NWAVE, SAVENAME )</code>
<ul>
<li><code>SPECPATH</code>: <em>string</em>- The path to the folder of opus files, from within the ‘Soil-Predictions-Example’ folder. Default set to “/Data_Raw/SPECTRA”</li>
<li><code>NWAVE</code>: <em>integer</em>- The number of wavelengths to extract. This will be set on the FTIR before running. The default is set to 3017, which we use at WHRC</li>
<li><code>SAVENAME</code>: <em>string</em>- The name you would like to save the spectral file after processing. The default is set to “none” which will not save a file.
_</li>
</ul></li>
</ul>
<p>Load appropriate packages for <code>opus_to_dataset()</code>…</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co">#---Packages---#</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw">library</span>(stringr) <span class="co">#used for str_sub</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw">library</span>(foreach) <span class="co">#used within read-opus-universal.R</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="kw">source</span>(<span class="st">&quot;Functions/gather-spc.R&quot;</span>) <span class="co">#simplerspec function</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="kw">source</span>(<span class="st">&quot;Functions/read-opus-universal.R&quot;</span>) <span class="co">#simplerspec function</span></a></code></pre></div>
<p>Get the paths of all OPUS files…</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co">#---List Files---#</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">spectraPath &lt;-<span class="st"> &quot;/Data_Raw/ref-SPECTRA&quot;</span> <span class="co">#folder of OPUS files</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">dirs &lt;-<span class="st"> </span><span class="kw">list.dirs</span>(<span class="kw">paste</span>(<span class="kw">getwd</span>(),spectraPath,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>), <span class="dt">full.names=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">all.files &lt;-<span class="st"> </span><span class="kw">list.files</span>(dirs, <span class="dt">pattern=</span> <span class="st">&quot;*.0&quot;</span>, <span class="dt">recursive=</span><span class="ot">TRUE</span>,<span class="dt">full.names=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<p>A single path will look something like this: <code>/Soil-Predictions-Example/Data_Raw/ref-SPECTRA/WHRC03405_S_001_030.0</code></p>
<p>Extract the spectra and gathers it into a tibble data frame…</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co">#---Extract Spectra---#</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">spc_list &lt;-<span class="st"> </span><span class="kw">read_opus_univ</span>(<span class="dt">fnames =</span> all.files, <span class="dt">extract =</span> <span class="kw">c</span>(<span class="st">&quot;spc&quot;</span>))</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">soilspec_tbl &lt;-<span class="st"> </span>spc_list <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="st">  </span><span class="kw">gather_spc</span>()</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">spc &lt;-<span class="st"> </span>soilspec_tbl<span class="op">$</span>spc</a></code></pre></div>
<p>Truncate the dataset to the number of wavelengths specified, to ensure the spectra from different samples align…</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co">#---Truncate Spectra---#</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  spc.trun &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(spc),<span class="cf">function</span>(x) spc[[x]][,<span class="dv">1</span><span class="op">:</span>NWAVE]) <span class="co"># Truncate at 3017 by default</span></a></code></pre></div>
<p>Process spectra into a dataframe and</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co">#---Process to Dataframe---#</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">spc.df &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">matrix</span>(<span class="kw">unlist</span>(spc), <span class="dt">nrow=</span><span class="kw">length</span>(spc), <span class="dt">byrow=</span>T))</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">colnames</span>(spc.df) &lt;-<span class="st"> </span><span class="kw">colnames</span>(spc[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="kw">rownames</span>(spc.df) &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="kw">seq</span>(<span class="dv">1</span>,<span class="kw">nrow</span>(spc.df)))</a></code></pre></div>
<p>Assign a <code>sample_id</code> based off the file names<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>…</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co">#---Assign sample_ids---#</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">spc.df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">sample_id =</span> soilspec_tbl<span class="op">$</span>sample_id, spc.df)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">spc.df<span class="op">$</span>sample_id &lt;-<span class="st"> </span><span class="kw">str_sub</span>(spc.df<span class="op">$</span>sample_id,<span class="dv">1</span>,<span class="dv">9</span>)</a></code></pre></div>
<p>Reformat the dataframe to have all the spectra as a matrix column…</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co">#---Reformat w/ Spectral Matrix Column---#</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">spectra &lt;-<span class="st"> </span><span class="kw">data.frame</span>(spc.df[,<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">spectra<span class="op">$</span>spc &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(spc.df[,<span class="dv">2</span><span class="op">:</span><span class="kw">ncol</span>(spc.df)])</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="kw">colnames</span>(spectra) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;sample_id&quot;</span>, <span class="st">&quot;spc&quot;</span>)</a></code></pre></div>
<p>Optionally save the spectra as an R dataset and csv file if <code>SAVENAME</code> is passed…</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co">#---Optionally Saves---#</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="cf">if</span>(SAVENAME <span class="op">!=</span><span class="st"> &quot;none&quot;</span>){</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">  <span class="kw">assign</span>(SAVENAME, spectra)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">  savefile &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Data_Processed/&quot;</span>, SAVENAME, <span class="st">&quot;.RData&quot;</span>)</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">  <span class="kw">save</span>(<span class="dt">list=</span> SAVENAME, <span class="dt">file=</span> savefile)</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">  <span class="kw">print</span>(SAVENAME,<span class="st">&quot;saved to&quot;</span>, savefile)</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">}</a></code></pre></div>
</div>
</div>
<div id="process-spectra" class="section level3 unnumbered">
<h3>Process Spectra</h3>
<div id="subset-spectral-range" class="section level4 unnumbered">
<h4>Subset Spectral Range</h4>
<p>To yield the best predictions, we exclude areas of the spectral range that may be problematic. The following function narrows down the regions of the spectra by truncating wavenumbers below 628 and between 2268 to 2389, which is a CO2 sensitive region</p>
</div>
<div id="subset_spectral_range" class="section level4 unnumbered">
<h4><code>subset_spectral_range()</code></h4>
<ul>
<li><code>subset_spectral_range( SPECTRA )</code>
<ul>
<li><code>SPECTRA</code>: <em>matrix</em>- A matrix of spectral data</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co">#---Edit Spectral Columns---#</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">col.names &lt;-<span class="st"> </span><span class="kw">colnames</span>(spectra<span class="op">$</span>spc) <span class="co">#get column names which are wavenumbers</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">col.names &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">substring</span>(col.names,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">cutoff &lt;-<span class="st"> </span><span class="kw">which</span>(col.names <span class="op">&lt;=</span><span class="st"> </span><span class="dv">628</span>)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">spectra<span class="op">$</span>spc &lt;-<span class="st"> </span>spectra<span class="op">$</span>spc[,<span class="op">-</span><span class="kw">c</span>(cutoff<span class="op">:</span><span class="kw">length</span>(col.names))] <span class="co">#truncate at &gt;= 628</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">min.index &lt;-<span class="st"> </span><span class="kw">which</span>(col.names <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2389</span>)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">max.index &lt;-<span class="st"> </span><span class="kw">which</span>(col.names <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2268</span>)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb13-10" data-line-number="10">spectra<span class="op">$</span>spc &lt;-<span class="st"> </span>spectra<span class="op">$</span>spc[,<span class="op">-</span><span class="kw">c</span>(min.index<span class="op">:</span>max.index)] <span class="co">#remove CO2 region</span></a></code></pre></div>
</div>
<div id="baseline-transformation" class="section level4 unnumbered">
<h4>Baseline Transformation</h4>
<p>We can perform a baseline transformation to normalize the spectra, by subtracting the minimum values for each row/sample.</p>
</div>
<div id="base_offset" class="section level4 unnumbered">
<h4><code>base_offset()</code></h4>
<ul>
<li><code>base_offset(x)</code>
<ul>
<li><code>x</code>: a matrix</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">library</span>(matrixStats) <span class="co"># Used for rowMins() function</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">base_offset &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  row_mins &lt;-<span class="st"> </span><span class="kw">rowMins</span>(x)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">  <span class="kw">return</span>(x<span class="op">-</span>row_mins) <span class="co"># Subtracts row_mins</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5">}</a></code></pre></div>
<!--could show head of the spectra, or a figure showing the dimensions-->
</div>
<div id="other-transformations" class="section level4 unnumbered">
<h4>Other Transformations</h4>
<ul>
<li>Standard Normal Variate</li>
<li>Derivatives</li>
<li>Continuum removal</li>
<li>Multiplicative scatter correction</li>
</ul>
</div>
<div id="calibration-transfer" class="section level4 unnumbered">
<h4>(Calibration Transfer)</h4>
<p>{Optional}
Recommended when the spectral library of samples to be predicted was scanned by a different instrument than the samples used to built the model.
For example, you would want to perform a calibration transfer on the prediction set, if you were using the KSSL library to make predictions on samples scanned at Woods Hole Research Center.</p>
</div>
</div>
<div id="merge-with-lab-data" class="section level3 unnumbered">
<h3>Merge with Lab Data</h3>
<p>If there is lab data associated with your soil samples, this can be merged with the spectral data and later used to assess the performance of your models. The example lab dataset below provides information about where the soil sample was taken with the Site_ID and Horizon, as well as the lab measurements for various soil properties including Organic Carbon, Sand, Silt and Clay.</p>
<!--discuss FTIR run-lists and associating IDs -->
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co">#---Read Lab Data---#</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">lab &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">read.csv</span>(<span class="st">&quot;Data_Raw/LAB_DATA.csv&quot;</span>))</a></code></pre></div>
<p>The merge() command joins the lab dataset to the spectral dataset. The all.y=TRUE parameter indicates that the final dataset will contain all the rows of spectra. This means that if some samples do not have lab data, they will be assigned a value of NA but the spectra will remain in the set.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co">#---Merge with Spectra---#</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">lab &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">read.csv</span>(LABPATH))</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">speclib &lt;-<span class="st"> </span><span class="kw">merge</span>(lab, spectra, <span class="dt">all.y=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<p>Optionally save the spectra as an R dataset and csv file if <code>SAVENAME</code> is passed within getSpecLib()…</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co">#---Optionally Saves---#</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="cf">if</span>(SAVENAME<span class="op">!=</span><span class="st"> &quot;none&quot;</span>){</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">  <span class="kw">assign</span>(SAVENAME,speclib)</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">  speclib &lt;-<span class="st"> </span><span class="kw">get</span>(SAVENAME)</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">  <span class="cf">if</span>(<span class="kw">file.exists</span>(<span class="st">&quot;./Data_Processed&quot;</span>)<span class="op">==</span><span class="ot">FALSE</span>){<span class="kw">dir.create</span>(<span class="st">&quot;./Data_Processed&quot;</span>)}</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">  savepath &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Data_Processed/&quot;</span>,SAVENAME,<span class="st">&quot;.RData&quot;</span>)</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">  <span class="kw">save</span>(speclib, <span class="dt">file=</span>savepath)</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">}</a></code></pre></div>
<p>The final dataframe contains a unique ID, lab data, and a matrix of spectral data called ‘spc’. It is suggested to save this file as RData so it may be reloaded as needed.</p>
</div>
</div>
<div id="refine-spectral-library" class="section level2 unnumbered">
<h2>Refine Spectral Library</h2>
<p>You may want to refine the samples you use to build your model or predict off of by…</p>
<ul>
<li>Subsetting the set to 15000 samples if it is large</li>
<li>Eliminating samples with NA, negative, or outlier lab data<br />
</li>
<li>Spliting the set or property subsets into calibration and validation groups</li>
</ul>
<div id="refinespeclib" class="section level3 unnumbered">
<h3><code>refineSpecLib()</code></h3>
<ul>
<li><code>refineSpecLib( SPECLIB, PROP, OUTLIER, LARGE, CALVAL, SAVENAME )</code>
<ul>
<li><code>SPECLIB</code>: <em>dataframe</em>- A dataframe object containing a sample_id column, a matrix of spectral data as column spc, and lab data columns if you intend to use the PROP parameter.</li>
<li><code>PROP</code>: <em>string</em>- The column name of the soil property of interest. If this is passed, the set will be refined using this lab data. Default is set to NA.</li>
<li><code>OUTLIER</code>: <em>vector</em>- A vector containing the outlier removal methods you would like applied to the data. Default is c(“stdev”) which detects lab data outliers. It can also be set to c(“fratio”) to detect spectral outliers, both c(“stdev”, “fratio”), or neither c(“none”)</li>
<li><code>LARGE</code>: <em>boolean</em>- Set to TRUE if you have a large dataset you would like to subset. Default is FALSE.</li>
<li><code>CALVAL</code>: <em>boolean</em>- Set to TRUE if you would like to create calibration and validation sets. It will return the dataset with a column, calib, that is assigned 1 for samples in the calibration set and 0 for those in the validation set. 80/20 split. Default is set to FALSE.</li>
<li><code>SAVENAME</code>: <em>string</em>- The name you would like to save the spectral file after processing. The default is set to “none” which will not save a file.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co"># Load outlier functions</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="kw">source</span>(<span class="st">&quot;Functions/outlier_functions.R&quot;</span>)</a>
<a class="sourceLine" id="cb18-3" data-line-number="3"></a>
<a class="sourceLine" id="cb18-4" data-line-number="4">refineSpecLib &lt;-<span class="st"> </span><span class="cf">function</span>(SPECLIB, <span class="dt">PROP=</span><span class="ot">NA</span>, <span class="dt">OUTLIER=</span><span class="kw">c</span>(<span class="st">&quot;stdev&quot;</span>), <span class="dt">LARGE=</span><span class="ot">FALSE</span>, </a>
<a class="sourceLine" id="cb18-5" data-line-number="5">                          <span class="dt">CALVAL=</span><span class="ot">FALSE</span>, <span class="dt">SAVENAME=</span><span class="st">&quot;none&quot;</span>){</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb18-7" data-line-number="7">  <span class="co"># Remove rows with faulty lab data</span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(PROP)){</a>
<a class="sourceLine" id="cb18-9" data-line-number="9">    SPECLIB  &lt;-<span class="st"> </span><span class="kw">noNA</span>(SPECLIB , PROP) <span class="co"># Remove NAs</span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10">    SPECLIB  &lt;-<span class="st"> </span><span class="kw">noNeg</span>(SPECLIB , PROP) <span class="co"># Remove Negative</span></a>
<a class="sourceLine" id="cb18-11" data-line-number="11">    <span class="cf">if</span>(<span class="st">&quot;stdev&quot;</span> <span class="op">%in%</span><span class="st"> </span>OUTLIER){</a>
<a class="sourceLine" id="cb18-12" data-line-number="12">      SPECLIB  &lt;-<span class="st"> </span>SPECLIB[<span class="op">-</span><span class="kw">stdev_outliers</span>(SPECLIB,PROP),] <span class="co"># Remove lab data outliers</span></a>
<a class="sourceLine" id="cb18-13" data-line-number="13">    } </a>
<a class="sourceLine" id="cb18-14" data-line-number="14">  }</a>
<a class="sourceLine" id="cb18-15" data-line-number="15">  </a>
<a class="sourceLine" id="cb18-16" data-line-number="16">  <span class="co"># Remove spectral outliers</span></a>
<a class="sourceLine" id="cb18-17" data-line-number="17">  <span class="cf">if</span>(<span class="op">!</span>(<span class="st">&quot;fratio&quot;</span> <span class="op">%in%</span><span class="st"> </span>OUTLIER)){</a>
<a class="sourceLine" id="cb18-18" data-line-number="18">    <span class="co">#SPECLIB  &lt;- SPECLIB[-fratio_outliers(SPECLIB),] # Identified with fratio</span></a>
<a class="sourceLine" id="cb18-19" data-line-number="19">  } </a>
<a class="sourceLine" id="cb18-20" data-line-number="20">  </a>
<a class="sourceLine" id="cb18-21" data-line-number="21">  <span class="co"># Subset a large dataset to 15000</span></a>
<a class="sourceLine" id="cb18-22" data-line-number="22">  <span class="cf">if</span>(LARGE<span class="op">==</span><span class="ot">TRUE</span>){</a>
<a class="sourceLine" id="cb18-23" data-line-number="23">    SPECLIB<span class="op">$</span>spc &lt;-<span class="st"> </span><span class="kw">sub_large_set</span>(SPECLIB) <span class="co"># Subset to 15000 samples</span></a>
<a class="sourceLine" id="cb18-24" data-line-number="24">  }</a>
<a class="sourceLine" id="cb18-25" data-line-number="25">  </a>
<a class="sourceLine" id="cb18-26" data-line-number="26">  <span class="co"># Split calibration/validation sets</span></a>
<a class="sourceLine" id="cb18-27" data-line-number="27">  <span class="cf">if</span>(CALVAL<span class="op">==</span><span class="ot">TRUE</span>){</a>
<a class="sourceLine" id="cb18-28" data-line-number="28">    SPECLIB &lt;-<span class="st"> </span><span class="kw">calValSplit</span>(SPECLIB)</a>
<a class="sourceLine" id="cb18-29" data-line-number="29">  }</a>
<a class="sourceLine" id="cb18-30" data-line-number="30">  </a>
<a class="sourceLine" id="cb18-31" data-line-number="31">  <span class="co"># Save the refined reference set for OC</span></a>
<a class="sourceLine" id="cb18-32" data-line-number="32">  <span class="cf">if</span>(SAVENAME <span class="op">!=</span><span class="st"> &quot;none&quot;</span>){</a>
<a class="sourceLine" id="cb18-33" data-line-number="33">    <span class="cf">if</span>(<span class="kw">file.exists</span>(<span class="st">&quot;./Data_Processed&quot;</span>)<span class="op">==</span><span class="ot">FALSE</span>){<span class="kw">dir.create</span>(<span class="st">&quot;./Data_Processed&quot;</span>)}</a>
<a class="sourceLine" id="cb18-34" data-line-number="34">    <span class="kw">assign</span>(SAVENAME, SPECLIB)</a>
<a class="sourceLine" id="cb18-35" data-line-number="35">    savefile &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Data_Processed/&quot;</span>, SAVENAME, <span class="st">&quot;.RData&quot;</span>)</a>
<a class="sourceLine" id="cb18-36" data-line-number="36">    <span class="kw">save</span>(<span class="dt">list=</span> SAVENAME, <span class="dt">file=</span> savefile)</a>
<a class="sourceLine" id="cb18-37" data-line-number="37">    <span class="kw">print</span>(SAVENAME,<span class="st">&quot;saved to&quot;</span>, savefile)</a>
<a class="sourceLine" id="cb18-38" data-line-number="38">  }</a>
<a class="sourceLine" id="cb18-39" data-line-number="39">  <span class="kw">return</span>(SPECLIB)</a>
<a class="sourceLine" id="cb18-40" data-line-number="40">}</a></code></pre></div>
</div>
<div id="large-sets" class="section level3 unnumbered">
<h3>Large Sets</h3>
<p>If you reference set exceeds 15000 samples, you may chose to subset it. We have found that 15000 is optimal for speed and performance of the models, when the reference set is very large. This subset can be performed using <strong>conditional latin hypercube sampling</strong>, with the <code>clhs</code> package.</p>
<div id="sub_large_set" class="section level4 unnumbered">
<h4><code>sub_large_set()</code></h4>
<ul>
<li><code>sub_large_set( SPECLIB, SUBCOUNT)</code>
<ul>
<li><code>SPECLIB</code>: <em>dataframe</em>- Dataframe including spectral data as a matrix ‘spc’</li>
<li><code>SUBCOUNT</code>: <em>integer</em>- Number of samples to subset. Default is set to 15000</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw">library</span>(clhs)</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">sub_large_set &lt;-<span class="st"> </span><span class="cf">function</span>(SPECLIB, <span class="dt">SUBCOUNT=</span><span class="dv">15000</span>){</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">  spectra &lt;-<span class="st"> </span><span class="kw">data.frame</span>(SPECLIB<span class="op">$</span>spc)</a>
<a class="sourceLine" id="cb19-4" data-line-number="4">  subset &lt;-<span class="st"> </span><span class="kw">clhs</span>(spectra, <span class="dt">size =</span> SUBCOUNT, <span class="dt">progress =</span> <span class="ot">TRUE</span>, <span class="dt">iter =</span> <span class="dv">500</span>)</a>
<a class="sourceLine" id="cb19-5" data-line-number="5">  SPECLIB &lt;-<span class="st"> </span>SPECLIB[subset,] <span class="co">#double check</span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6">  <span class="kw">return</span>(SPECLIB)</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">}</a></code></pre></div>
</div>
</div>
<div id="faulty-lab-data" class="section level3 unnumbered">
<h3>Faulty Lab Data</h3>
<p>To yield the best models, we can exclude rows with faulty lab data (NA, negative, and outlier values). This may vary by soil property, so the process should be repeated for each property.</p>
<div id="nona" class="section level4 unnumbered">
<h4><code>noNA()</code></h4>
<ul>
<li><code>noNA( dataset, column )</code>
<ul>
<li><code>dataset</code>: dataframe to eliminate NAs from</li>
<li><code>column</code>: column to check for NA values</li>
</ul></li>
</ul>
<p>Gets rid of NA values…</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">noNA &lt;-<span class="st"> </span><span class="cf">function</span>(dataset, column){</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">  <span class="kw">return</span>(dataset[<span class="op">!</span><span class="kw">is.na</span>(dataset[,column]),])</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">}</a></code></pre></div>
</div>
<div id="noneg" class="section level4 unnumbered">
<h4><code>noNeg()</code></h4>
<ul>
<li><code>noNeg( dataset, column )</code>
<ul>
<li><code>dataset</code>: dataframe to eliminate negative values from</li>
<li><code>column</code>: column to check for negative values</li>
</ul></li>
</ul>
<p>Gets rid of Negative values…</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">noNeg &lt;-<span class="st"> </span><span class="cf">function</span>(dataset, column){</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">  <span class="kw">return</span>(dataset[<span class="kw">which</span>(dataset[,column] <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>),])</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">}</a></code></pre></div>
</div>
</div>
<div id="outliers" class="section level3 unnumbered">
<h3>Outliers</h3>
<p>We can identify both outliers in the lab data and outliers in the spectral data, to optimize our models. The following functions are called based on the variable <code>OUTLIER</code> passed in <code>refineSpecLib()</code>. They are stored in <code>outlier_functions.R</code></p>
<div id="lab-data-outliers" class="section level4 unnumbered">
<h4>Lab Data Outliers</h4>
<p>This outlier detection approach creates a PLS model, regresses the predictions against the lab data, and identifies the 1% of samples that were farthest from the line of best fit. These samples will be printed out in the consol and highlighted on a plot like the one below. In this case, the sample size is about 600, so 6 outliers were identified.</p>
<p><img src="images/lab_outliers.png" /></p>
</div>
<div id="stdev_outliers" class="section level4 unnumbered">
<h4><code>stdev_outliers()</code></h4>
<ul>
<li><code>stdev_outliers( SPECLIB, PROP, SHOW, PLOT )</code>
<ul>
<li><code>SPECLIB</code>: <em>dataframe</em> A dataframe to eliminate standard deviation outliers from</li>
<li><code>PROP</code>: <em>string</em> A column to check for standard deviation outliers</li>
<li><code>SHOW</code>: <em>boolean</em> Whether or not to show results. Default is TRUE.</li>
<li><code>PLOT</code>: <em>boolean</em> Whether or not to plot results. Default is TRUE.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">stdev_outliers &lt;-<span class="st"> </span><span class="cf">function</span>(SPECLIB, PROP, <span class="dt">SHOW=</span><span class="ot">TRUE</span>, <span class="dt">PLOT=</span><span class="ot">TRUE</span>){</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"></a>
<a class="sourceLine" id="cb22-3" data-line-number="3">  <span class="co"># Create a PLS model with the data</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4">  pls.fit &lt;-<span class="st"> </span><span class="kw">plsr</span>(<span class="kw">sqrt</span>(<span class="kw">get</span>(PROP))<span class="op">~</span>spc, <span class="dt">ncomp=</span> <span class="dv">20</span>, <span class="dt">data =</span> SPECLIB, <span class="dt">valid=</span><span class="st">&quot;CV&quot;</span>, <span class="dt">segments =</span> <span class="dv">50</span>) <span class="co">#y, x, number components, data, cross validation,</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5">  pred &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">predict</span>(pls.fit, <span class="dt">newdata =</span> SPECLIB<span class="op">$</span>spc,<span class="dt">ncomp=</span><span class="dv">20</span>))<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"></a>
<a class="sourceLine" id="cb22-7" data-line-number="7">  <span class="co"># Identify outliers using a standard deviation threshold</span></a>
<a class="sourceLine" id="cb22-8" data-line-number="8">  sd.outlier &lt;-<span class="st"> </span><span class="kw">optimum_sd_outlier</span>(pred, SPECLIB[,PROP], <span class="kw">seq</span>(<span class="fl">0.1</span>,<span class="dv">3</span>, <span class="dt">by =</span><span class="fl">0.02</span>))</a>
<a class="sourceLine" id="cb22-9" data-line-number="9">  outliers &lt;-<span class="st"> </span><span class="kw">outlier_indices</span>(pred, SPECLIB[,PROP], sd.outlier[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb22-10" data-line-number="10"></a>
<a class="sourceLine" id="cb22-11" data-line-number="11">  <span class="co"># Display outlier identification</span></a>
<a class="sourceLine" id="cb22-12" data-line-number="12">  <span class="cf">if</span>(SHOW<span class="op">==</span><span class="ot">TRUE</span>){</a>
<a class="sourceLine" id="cb22-13" data-line-number="13"></a>
<a class="sourceLine" id="cb22-14" data-line-number="14">    <span class="co"># Show outlier prediction versus observed values</span></a>
<a class="sourceLine" id="cb22-15" data-line-number="15">    predobs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(pred, SPECLIB[,PROP])</a>
<a class="sourceLine" id="cb22-16" data-line-number="16">    <span class="kw">names</span>(predobs) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;pred&quot;</span>, <span class="st">&quot;obs&quot;</span>)</a>
<a class="sourceLine" id="cb22-17" data-line-number="17">    <span class="kw">print</span>(predobs[outliers,])</a>
<a class="sourceLine" id="cb22-18" data-line-number="18"></a>
<a class="sourceLine" id="cb22-19" data-line-number="19">    <span class="co"># Plot with Outliers</span></a>
<a class="sourceLine" id="cb22-20" data-line-number="20">    <span class="kw">plot</span>(pred <span class="op">~</span><span class="st"> </span>obs, <span class="dt">data=</span>predobs[<span class="op">-</span>outliers,], <span class="dt">main=</span><span class="st">&quot;Lab Outliers&quot;</span>)</a>
<a class="sourceLine" id="cb22-21" data-line-number="21">    <span class="kw">points</span>(pred <span class="op">~</span><span class="st"> </span>obs, <span class="dt">data=</span>predobs[outliers,], <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">pch=</span><span class="dv">24</span>, <span class="dt">bg=</span><span class="st">&quot;red&quot;</span>)</a>
<a class="sourceLine" id="cb22-22" data-line-number="22"></a>
<a class="sourceLine" id="cb22-23" data-line-number="23">  }</a>
<a class="sourceLine" id="cb22-24" data-line-number="24">  <span class="kw">return</span>(outliers)</a>
<a class="sourceLine" id="cb22-25" data-line-number="25">}</a></code></pre></div>
</div>
<div id="spectral-outliers" class="section level4 unnumbered">
<h4>Spectral Outliers</h4>
<p>There may also be outliers in the spectral data, which we can detect and remove. Eliminating them from the <strong>reference set</strong> may build a stronger model, so this can be performed in the preprocessing stage. For the <strong>prediction set</strong>, you may want to see where the prediction samples lie within the reference set as well. Is the reference set data representative of the prediction set samples? If they fall to far outside of the reference set space, you might decide it is not appropriate to make predictions for these samples.</p>
<p>To detect spectral outliers, we can look at the spectra in <strong>principal component space</strong> and identify which samples are farthest from the center of the data. We use a statistic called the <strong>fratio</strong>, to measure this variation. Using the scores and loadings from principal component analysis, we get predictions of the spectra, which can be compared to the actual values of the spectra. Looking at the probability distribution of the residuals with the fratio, we can flag samples that vary significantly from their predicted values.</p>
<p>The 3D plot below shows an example of spectral outliers being detected in the principal component space of PC1, PC2 and PC3:</p>
<p><img src="images/fratio_outliers.png" /></p>
</div>
<div id="fratio_outliers" class="section level4 unnumbered">
<h4><code>fratio_outliers()</code></h4>
<ul>
<li><code>fratio_outliers( SPECLIB, P, SHOW, PLOT )</code>
<ul>
<li><code>SPECLIB</code>: <em>dataframe</em>- A dataframe to eliminate standard deviation outliers from. Must include spectral matrix as ‘spc’ column.</li>
<li><code>P</code>: <em>double</em>- A fraction signifying the threshold to be used for detecting outliers. Default is set to 0.99</li>
<li><code>SHOW</code>: <em>boolean</em>- Whether or not to show results. Default is TRUE.</li>
<li><code>PLOT</code>: <em>boolean</em>- Whether or not to plot results. Default is TRUE.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">library</span>(plot3D) <span class="co"># For 3D plot</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2">fratio_outliers &lt;-<span class="st"> </span><span class="cf">function</span>(SPECLIB, <span class="dt">P=</span><span class="fl">0.99</span>, <span class="dt">SHOW=</span><span class="ot">TRUE</span>, <span class="dt">PLOT=</span><span class="ot">TRUE</span>){</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb23-4" data-line-number="4">  <span class="co"># Get Principle Component Analysis</span></a>
<a class="sourceLine" id="cb23-5" data-line-number="5">  pca &lt;-<span class="st"> </span><span class="kw">prcomp</span>(SPECLIB<span class="op">$</span>spc)</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">  <span class="co"># Get Scores</span></a>
<a class="sourceLine" id="cb23-7" data-line-number="7">  scores &lt;-<span class="st"> </span>pca<span class="op">$</span>x</a>
<a class="sourceLine" id="cb23-8" data-line-number="8">  <span class="co"># Get Loadings</span></a>
<a class="sourceLine" id="cb23-9" data-line-number="9">  loadings &lt;-<span class="st"> </span>pca<span class="op">$</span>rotation</a>
<a class="sourceLine" id="cb23-10" data-line-number="10">  <span class="co"># Get Predicted Spectra</span></a>
<a class="sourceLine" id="cb23-11" data-line-number="11">  pred_spc &lt;-<span class="st"> </span>scores <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(loadings) </a>
<a class="sourceLine" id="cb23-12" data-line-number="12">  <span class="co"># Scale Spectra</span></a>
<a class="sourceLine" id="cb23-13" data-line-number="13">  spc &lt;-<span class="st"> </span><span class="kw">scale</span>(SPECLIB<span class="op">$</span>spc,<span class="dt">scale=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb23-14" data-line-number="14">  <span class="co"># Get Residuals</span></a>
<a class="sourceLine" id="cb23-15" data-line-number="15">  res &lt;-<span class="st"> </span>(pred_spc <span class="op">-</span><span class="st"> </span>spc)<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb23-16" data-line-number="16">  res &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">rowSums</span>(res))</a>
<a class="sourceLine" id="cb23-17" data-line-number="17">  <span class="co"># Get Fratio</span></a>
<a class="sourceLine" id="cb23-18" data-line-number="18">  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(res)){</a>
<a class="sourceLine" id="cb23-19" data-line-number="19">    sample.fratio &lt;-<span class="st"> </span>(<span class="kw">length</span>(res)<span class="op">-</span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>res<span class="op">^</span><span class="dv">2</span><span class="op">/</span><span class="kw">sum</span>((res[<span class="op">-</span>i])<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb23-20" data-line-number="20">  }</a>
<a class="sourceLine" id="cb23-21" data-line-number="21">  <span class="co"># Get Samples that Exceed the Threshold, P</span></a>
<a class="sourceLine" id="cb23-22" data-line-number="22">  ok &lt;-<span class="st"> </span><span class="kw">pf</span>(sample.fratio, <span class="dv">1</span>, <span class="kw">length</span>(res)) </a>
<a class="sourceLine" id="cb23-23" data-line-number="23">  outliers &lt;-<span class="st"> </span><span class="kw">which</span>(ok<span class="op">&gt;</span>P)</a>
<a class="sourceLine" id="cb23-24" data-line-number="24">  </a>
<a class="sourceLine" id="cb23-25" data-line-number="25">  <span class="co"># Display Results</span></a>
<a class="sourceLine" id="cb23-26" data-line-number="26">  <span class="cf">if</span>(<span class="kw">length</span>(outliers)<span class="op">&gt;</span><span class="dv">0</span>){ <span class="co"># If there are spectral outliers</span></a>
<a class="sourceLine" id="cb23-27" data-line-number="27">    <span class="cf">if</span>(PLOT<span class="op">==</span><span class="ot">TRUE</span>){</a>
<a class="sourceLine" id="cb23-28" data-line-number="28">      <span class="co"># 3D Plot</span></a>
<a class="sourceLine" id="cb23-29" data-line-number="29">      x &lt;-<span class="st"> </span>pc1 &lt;-<span class="st"> </span>scores[,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb23-30" data-line-number="30">      y &lt;-<span class="st"> </span>pc2 &lt;-<span class="st"> </span>scores[,<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb23-31" data-line-number="31">      z &lt;-<span class="st"> </span>pc3 &lt;-<span class="st"> </span>scores[,<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb23-32" data-line-number="32">      <span class="kw">scatter3D</span>(x,y,z, <span class="dt">col=</span><span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb23-33" data-line-number="33">      <span class="kw">points3D</span>(x[outliers], y[outliers], z[outliers], <span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">add=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-34" data-line-number="34">    }</a>
<a class="sourceLine" id="cb23-35" data-line-number="35">    <span class="cf">if</span>(SHOW<span class="op">==</span><span class="ot">TRUE</span>){</a>
<a class="sourceLine" id="cb23-36" data-line-number="36">      <span class="co"># Print Outliers</span></a>
<a class="sourceLine" id="cb23-37" data-line-number="37">      <span class="kw">print</span>(<span class="st">&quot;Spectral Outliers&quot;</span>)</a>
<a class="sourceLine" id="cb23-38" data-line-number="38">      <span class="kw">print</span>(<span class="kw">data.frame</span>(<span class="dt">sample_id=</span>SPECLIB[outliers,<span class="dv">1</span>], <span class="dt">PF=</span><span class="kw">round</span>(ok[outliers],<span class="dv">6</span>)))</a>
<a class="sourceLine" id="cb23-39" data-line-number="39">    }</a>
<a class="sourceLine" id="cb23-40" data-line-number="40">    <span class="kw">return</span>(outliers)</a>
<a class="sourceLine" id="cb23-41" data-line-number="41">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb23-42" data-line-number="42">    <span class="kw">print</span>(<span class="st">&quot;No Spectral Outliers&quot;</span>)</a>
<a class="sourceLine" id="cb23-43" data-line-number="43">  }</a>
<a class="sourceLine" id="cb23-44" data-line-number="44">}</a></code></pre></div>
<!--Insert plot showing the outlier selection process-->
</div>
</div>
<div id="calval-groups" class="section level3 unnumbered">
<h3>Cal/Val Groups</h3>
<p>You may chose to subset a portion of the reference set as a calibration group which will be used to build the models- leaving the remaining samples as the validation set to test the model. <strong>Kennard Stone</strong> is a method for performing this type of separation while ensuring each group is representative of the set. The following function returns the spectral library with an additional column, ‘calib’, signifying whether or not the sample is in the calibration set. This is used in the <a href="https://whrc.github.io/Soil-Predictions-MIR/getting-started.html#demo-script">demo script</a> to define the reference set and prediction set:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">refSet &lt;-<span class="st"> </span>OC_data[OC_data<span class="op">$</span>calib<span class="op">==</span><span class="dv">1</span>,]</a>
<a class="sourceLine" id="cb24-2" data-line-number="2">predSet &lt;-<span class="st"> </span>OC_data[OC_data<span class="op">$</span>calib<span class="op">==</span><span class="dv">0</span>,]</a></code></pre></div>
<div id="calvalsplit" class="section level4 unnumbered">
<h4><code>calValSplit()</code></h4>
<ul>
<li><code>calValSplit( SPECLIB, FRAC )</code>
<ul>
<li><code>SPECLIB</code>: <em>dataframe</em>- The dataset containing a spectral matrix as column spc.</li>
<li><code>FRAC</code>: <em>double</em>- The fraction of data to be allocated to the calibration set. The default is 0.8 or 80%.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw">library</span>(prospectr)</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">calValSplit &lt;-<span class="st"> </span><span class="cf">function</span>(dataset){</a>
<a class="sourceLine" id="cb25-3" data-line-number="3">  <span class="co">#perform kennard stone to separate data into 80% calibration and 20% validation sets</span></a>
<a class="sourceLine" id="cb25-4" data-line-number="4">  ken_stone&lt;-<span class="st"> </span>prospectr<span class="op">::</span><span class="kw">kenStone</span>(<span class="dt">X =</span> dataset<span class="op">$</span>spc, </a>
<a class="sourceLine" id="cb25-5" data-line-number="5">                                  <span class="dt">k =</span> <span class="kw">as.integer</span>(<span class="fl">0.8</span><span class="op">*</span><span class="kw">nrow</span>(dataset)), </a>
<a class="sourceLine" id="cb25-6" data-line-number="6">                                  <span class="dt">metric =</span> <span class="st">&quot;mahal&quot;</span>, <span class="dt">pc =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb25-7" data-line-number="7">  calib &lt;-<span class="st"> </span>dataset[ken_stone<span class="op">$</span>model, ]</a>
<a class="sourceLine" id="cb25-8" data-line-number="8">  valid &lt;-<span class="st"> </span>dataset[ken_stone<span class="op">$</span>test, ]</a>
<a class="sourceLine" id="cb25-9" data-line-number="9">  </a>
<a class="sourceLine" id="cb25-10" data-line-number="10">  <span class="kw">return</span>(<span class="kw">c</span>(calib, valid))</a>
<a class="sourceLine" id="cb25-11" data-line-number="11">}</a></code></pre></div>

</div>
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="1">
<li id="fn1"><p>sample_ids that are numeric may cause issues while merging so a string ID is advised<a href="data-preprocessing.html#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="getting-started.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="plsr-models.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "sepia",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
